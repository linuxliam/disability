name: Validate Project

on:
  workflow_call:
    inputs:
      xcode_version:
        required: false
        type: string
        default: '15.1'
        description: 'Xcode version to use'
    outputs:
      validation-status:
        description: 'Validation status (success or failure)'
        value: ${{ jobs.validate.outputs.status }}

jobs:
  validate:
    name: âœ… Validate Project
    runs-on: macos-14
    timeout-minutes: 5
    outputs:
      status: ${{ steps.validation-status.outputs.status }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ inputs.xcode_version }}

      - name: âœ… Validate Project Structure
        run: |
          echo "ðŸ” Validating project structure..."
          
          # Check required files exist
          [ -f "DisabilityAdvocacy.xcodeproj/project.pbxproj" ] || { echo "âŒ Project file missing"; exit 1; }
          [ -f "iOS/Info.plist" ] || { echo "âŒ iOS Info.plist missing"; exit 1; }
          [ -f "macOS/Info.plist" ] || { echo "âŒ macOS Info.plist missing"; exit 1; }
          
          echo "âœ… Required files present"

      - name: âœ… Validate Xcode Project
        run: |
          echo "ðŸ” Validating Xcode project..."
          xcodebuild -list -project DisabilityAdvocacy.xcodeproj || { echo "âŒ Project validation failed"; exit 1; }
          echo "âœ… Xcode project is valid"

      - name: âœ… Validate Resources
        run: |
          echo "ðŸ” Validating resources..."
          
          [ -f "Resources/Assets.xcassets/Contents.json" ] || echo "âš ï¸ Assets.xcassets missing"
          [ -f "Resources/Events.json" ] || echo "âš ï¸ Events.json missing"
          [ -f "Resources/Resources.json" ] || echo "âš ï¸ Resources.json missing"
          
          echo "âœ… Resource validation complete"

      - name: âœ… Validate Dependencies
        run: |
          echo "ðŸ” Validating dependencies..."
          
          if grep -r "packageReferences" DisabilityAdvocacy.xcodeproj/project.pbxproj > /dev/null 2>&1; then
            echo "ðŸ“¦ Package dependencies found, resolving..."
            xcodebuild -resolvePackageDependencies -project DisabilityAdvocacy.xcodeproj || { echo "âŒ Dependency resolution failed"; exit 1; }
            echo "âœ… Dependencies resolved"
          else
            echo "â„¹ï¸ No package dependencies found"
          fi

      - name: ðŸ“Š Set Validation Status
        id: validation-status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
