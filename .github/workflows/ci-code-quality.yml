name: CI - Code Quality

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      skip_lint:
        description: 'Skip code quality checks'
        required: false
        default: false
        type: boolean

env:
  XCODE_VERSION: '15.1'

jobs:
  code-quality:
    name: üîç Code Quality Check
    runs-on: macos-14
    timeout-minutes: 5
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.skip_lint != 'true'
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üì¶ Cache SwiftLint
        uses: actions/cache@v4
        id: swiftlint-cache
        with:
          path: |
            ~/.swiftlint
            /usr/local/bin/swiftlint
          key: ${{ runner.os }}-swiftlint-${{ hashFiles('**/.swiftlint.yml') }}
          restore-keys: |
            ${{ runner.os }}-swiftlint-
      
      - name: üîç Run SwiftLint
        run: |
          if command -v swiftlint &> /dev/null; then
            swiftlint lint --reporter github-actions-logging || true
          else
            echo "‚ö†Ô∏è SwiftLint not installed, skipping..."
          fi
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          START_TIME=${{ steps.timer.outputs.result }}
          END_TIME=$(date +%s)000
          DURATION=$(( (END_TIME - START_TIME) / 1000 ))
          echo "‚è±Ô∏è Code Quality Check completed in ${DURATION}s"
