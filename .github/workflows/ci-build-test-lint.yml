name: Continuous Integration - Build, Test, and Validate

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration (Debug or Release)'
        required: false
        default: 'Debug'
        type: choice
        options:
          - Debug
          - Release
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean
      skip_lint:
        description: 'Skip code quality checks'
        required: false
        default: false
        type: boolean

# Concurrency control: cancel in-progress runs for same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '15.0'
  SWIFT_VERSION: '5.9'
  CONFIGURATION: ${{ github.event.inputs.configuration || 'Debug' }}
  SKIP_TESTS: ${{ github.event.inputs.skip_tests == 'true' || false }}
  SKIP_LINT: ${{ github.event.inputs.skip_lint == 'true' || false }}

jobs:
  # ============================================================================
  # Gate 1: Code Quality Check
  # Purpose: Verify code follows linting standards
  # ============================================================================
  code-quality:
    name: üîç Code Quality Check
    runs-on: macos-14
    timeout-minutes: 5
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.skip_lint != 'true'
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üì¶ Cache SwiftLint
        uses: actions/cache@v4
        id: swiftlint-cache
        with:
          path: |
            ~/.swiftlint
            /usr/local/bin/swiftlint
          key: ${{ runner.os }}-swiftlint-${{ hashFiles('**/.swiftlint.yml') }}
          restore-keys: |
            ${{ runner.os }}-swiftlint-
      
      - name: üîç Run SwiftLint
        run: |
          if command -v swiftlint &> /dev/null; then
            swiftlint lint --reporter github-actions-logging || true
          else
            echo "‚ö†Ô∏è SwiftLint not installed, skipping..."
          fi
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          echo "‚è±Ô∏è Code Quality Check completed in ${DURATION}s"

  # ============================================================================
  # Gate 2: Project Structure Validation
  # Purpose: Verify project files and structure are valid
  # ============================================================================
  validate-project:
    name: ‚úÖ Project Structure Validation
    runs-on: macos-14
    timeout-minutes: 3
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ‚úÖ Validate Project
        run: |
          [ -f "DisabilityAdvocacy.xcodeproj/project.pbxproj" ] || exit 1
          [ -f "iOS/Info.plist" ] || exit 1
          [ -f "macOS/Info.plist" ] || exit 1
          xcodebuild -list -project DisabilityAdvocacy.xcodeproj || exit 1
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          echo "‚è±Ô∏è Project Validation completed in ${DURATION}s"

  # ============================================================================
  # Gate 3: Dependency Validation & Caching
  # Purpose: Verify all dependencies can be resolved and cache them
  # ============================================================================
  validate-dependencies:
    name: üì¶ Dependency Validation
    runs-on: macos-14
    timeout-minutes: 5
    outputs:
      cache-hit: ${{ steps.cache-spm.outputs.cache-hit }}
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üì¶ Cache Swift Package Manager
        uses: actions/cache@v4
        id: cache-spm
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            ~/.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: üì¶ Resolve Dependencies
        if: steps.cache-spm.outputs.cache-hit != 'true'
        run: |
          if grep -r "packageReferences" DisabilityAdvocacy.xcodeproj/project.pbxproj > /dev/null 2>&1; then
            xcodebuild -resolvePackageDependencies -project DisabilityAdvocacy.xcodeproj || exit 1
          fi
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          CACHE_STATUS=${{ steps.cache-spm.outputs.cache-hit == 'true' && '‚úÖ Cache Hit' || '‚ùå Cache Miss' }}
          echo "‚è±Ô∏è Dependency Validation completed in ${DURATION}s (${CACHE_STATUS})"

  # ============================================================================
  # Gate 4: Swift 6 Concurrency Pre-Check
  # Purpose: Detect potential concurrency issues before build
  # ============================================================================
  concurrency-check:
    name: ‚ö° Swift 6 Concurrency Check
    runs-on: macos-14
    timeout-minutes: 5
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîç Check Concurrency Patterns
        run: |
          CONCURRENCY_ISSUES=0
          while IFS= read -r file; do
            if grep -q "Manager\.shared\." "$file" && ! grep -q "@MainActor" "$file"; then
              CONCURRENCY_ISSUES=$((CONCURRENCY_ISSUES + 1))
            fi
          done < <(find Shared -name "*.swift" -type f 2>/dev/null)
          echo "Found $CONCURRENCY_ISSUES potential concurrency issue(s)"
          exit 0
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          echo "‚è±Ô∏è Concurrency Check completed in ${DURATION}s"

  # ============================================================================
  # Gate 5: Security Scan
  # Purpose: Check for hardcoded secrets and security issues
  # ============================================================================
  security-scan:
    name: üîí Security Scan
    runs-on: macos-14
    timeout-minutes: 3
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîí Scan for Secrets
        run: |
          SECRET_PATTERNS=("api[_-]?key" "secret" "token" "password")
          for pattern in "${SECRET_PATTERNS[@]}"; do
            grep -r -i "$pattern" --include="*.swift" --include="*.plist" . 2>/dev/null | grep -v ".git" | head -5 || true
          done
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          echo "‚è±Ô∏è Security Scan completed in ${DURATION}s"

  # ============================================================================
  # Gate 6: Build iOS Application
  # Purpose: Compile iOS app for specified configuration
  # ============================================================================
  build-ios:
    name: üì± Build iOS (${{ matrix.configuration }})
    runs-on: macos-14
    timeout-minutes: 25
    needs: [validate-project, validate-dependencies]
    if: always()
    strategy:
      fail-fast: false
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üì¶ Cache Build Artifacts
        uses: actions/cache@v4
        id: cache-build
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            build
          key: ${{ runner.os }}-ios-${{ matrix.configuration }}-${{ hashFiles('**/*.swift', '**/project.pbxproj', '**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-ios-${{ matrix.configuration }}-
            ${{ runner.os }}-ios-
      
      - name: üî® Build
        run: |
          set -o pipefail
          BUILD_START=$(date +%s)
          xcodebuild \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-iOS" \
            -sdk iphonesimulator \
            -configuration ${{ matrix.configuration }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            -derivedDataPath build \
            clean build \
            2>&1 | tee build-ios-${{ matrix.configuration }}.log || BUILD_EXIT_CODE=$?
          
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          echo "‚è±Ô∏è Build took ${BUILD_DURATION}s"
          
          if [ ${BUILD_EXIT_CODE:-0} -ne 0 ]; then
            echo "## ‚ùå Build Failed (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚è±Ô∏è **Build Duration:** ${BUILD_DURATION}s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract error types
            CONCURRENCY_ERRORS=$(grep -c "main actor-isolated\|nonisolated context" build-ios-${{ matrix.configuration }}.log 2>/dev/null || echo "0")
            COMPILATION_ERRORS=$(grep -c "error:" build-ios-${{ matrix.configuration }}.log 2>/dev/null || echo "0")
            LINKER_ERRORS=$(grep -c "Undefined symbol\|ld:" build-ios-${{ matrix.configuration }}.log 2>/dev/null || echo "0")
            
            echo "### Error Summary" >> $GITHUB_STEP_SUMMARY
            echo "- **Concurrency Errors:** $CONCURRENCY_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Compilation Errors:** $COMPILATION_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Linker Errors:** $LINKER_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show concurrency errors if any
            if [ "$CONCURRENCY_ERRORS" -gt 0 ]; then
              echo "### üî¥ Swift 6 Concurrency Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -B 2 -A 5 "main actor-isolated\|nonisolated context" build-ios-${{ matrix.configuration }}.log | head -50 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show compilation errors
            if [ "$COMPILATION_ERRORS" -gt 0 ]; then
              echo "### Compilation Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "error:" build-ios-${{ matrix.configuration }}.log | head -30 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show last 50 lines for context
            echo "### Full Build Log (Last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 build-ios-${{ matrix.configuration }}.log >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            exit ${BUILD_EXIT_CODE:-1}
          fi
      
      - name: ‚úÖ Validate Bundle
        if: success()
        run: |
          APP_PATH="build/${{ matrix.configuration == 'Debug' && 'Debug' || 'Release' }}-iphonesimulator/DisabilityAdvocacy-iOS.app"
          [ -d "$APP_PATH" ] && [ -f "$APP_PATH/Info.plist" ] || exit 1
      
      - name: üì§ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ matrix.configuration }}
          path: |
            build-ios-${{ matrix.configuration }}.log
          retention-days: 7
          compression-level: 6
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          CACHE_STATUS=${{ steps.cache-build.outputs.cache-hit == 'true' && '‚úÖ Cache Hit' || '‚ùå Cache Miss' }}
          echo "‚è±Ô∏è iOS Build (${{ matrix.configuration }}) completed in ${DURATION}s (${CACHE_STATUS})"

  # ============================================================================
  # Gate 7: Build macOS Application
  # Purpose: Compile macOS app for specified configuration
  # ============================================================================
  build-macos:
    name: üíª Build macOS (${{ matrix.configuration }})
    runs-on: macos-14
    timeout-minutes: 25
    needs: [validate-project, validate-dependencies]
    if: always()
    strategy:
      fail-fast: false
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üì¶ Cache Build Artifacts
        uses: actions/cache@v4
        id: cache-build
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            build
          key: ${{ runner.os }}-macos-${{ matrix.configuration }}-${{ hashFiles('**/*.swift', '**/project.pbxproj', '**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-macos-${{ matrix.configuration }}-
            ${{ runner.os }}-macos-
      
      - name: üî® Build
        run: |
          BUILD_START=$(date +%s)
          xcodebuild \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-macOS" \
            -sdk macosx \
            -configuration ${{ matrix.configuration }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build \
            clean build \
            2>&1 | tee build-macos-${{ matrix.configuration }}.log || exit 1
          
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          echo "‚è±Ô∏è Build took ${BUILD_DURATION}s"
      
      - name: ‚úÖ Validate Bundle
        if: success()
        run: |
          APP_PATH="build/${{ matrix.configuration }}/DisabilityAdvocacy-macOS.app"
          [ -d "$APP_PATH" ] && [ -f "$APP_PATH/Contents/Info.plist" ] || exit 1
      
      - name: üì§ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ matrix.configuration }}
          path: |
            build-macos-${{ matrix.configuration }}.log
          retention-days: 7
          compression-level: 6
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          CACHE_STATUS=${{ steps.cache-build.outputs.cache-hit == 'true' && '‚úÖ Cache Hit' || '‚ùå Cache Miss' }}
          echo "‚è±Ô∏è macOS Build (${{ matrix.configuration }}) completed in ${DURATION}s (${CACHE_STATUS})"

  # ============================================================================
  # Gate 8: Test iOS Application
  # Purpose: Execute iOS unit tests
  # ============================================================================
  test-ios:
    name: üß™ Test iOS (${{ matrix.device }})
    runs-on: macos-14
    timeout-minutes: 20
    needs: [build-ios]
    if: always() && (github.event_name != 'workflow_dispatch' || github.event.inputs.skip_tests != 'true')
    strategy:
      fail-fast: false
      matrix:
        device: [iPhone 15, iPhone 15 Pro]
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üì¶ Cache Test Artifacts
        uses: actions/cache@v4
        id: cache-tests
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build
          key: ${{ runner.os }}-test-ios-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-test-ios-
      
      - name: üì± Find Simulator
        id: simulator
        run: |
          DEVICE_UDID=$(xcrun simctl list devices available | grep -i "${{ matrix.device }}" | grep -i "iphone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          if [ -z "$DEVICE_UDID" ]; then
            DEVICE_UDID=$(xcrun simctl list devices available | grep -i "iphone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          fi
          if [ -z "$DEVICE_UDID" ]; then
            echo "destination=generic/platform=iOS Simulator" >> $GITHUB_OUTPUT
          else
            xcrun simctl boot "$DEVICE_UDID" 2>/dev/null || true
            sleep 3
            echo "destination=platform=iOS Simulator,id=$DEVICE_UDID" >> $GITHUB_OUTPUT
          fi
      
      - name: üß™ Run Tests
        run: |
          TEST_START=$(date +%s)
          xcodebuild test \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-iOS" \
            -sdk iphonesimulator \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -destination "${{ steps.simulator.outputs.destination }}" \
            -derivedDataPath build \
            -only-testing:DisabilityAdvocacyTests \
            2>&1 | tee test-output-${{ matrix.device }}.txt || exit 1
          
          TEST_END=$(date +%s)
          TEST_DURATION=$((TEST_END - TEST_START))
          echo "‚è±Ô∏è Tests took ${TEST_DURATION}s"
      
      - name: üì§ Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-${{ matrix.device }}
          path: test-output-${{ matrix.device }}.txt
          retention-days: 7
          compression-level: 6
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          echo "‚è±Ô∏è iOS Tests (${{ matrix.device }}) completed in ${DURATION}s"

  # ============================================================================
  # Gate 9: Test macOS Application
  # Purpose: Execute macOS unit tests
  # ============================================================================
  test-macos:
    name: üß™ Test macOS
    runs-on: macos-14
    timeout-minutes: 15
    needs: [build-macos]
    if: always() && (github.event_name != 'workflow_dispatch' || github.event.inputs.skip_tests != 'true')
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: üì¶ Cache Test Artifacts
        uses: actions/cache@v4
        id: cache-tests
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build
          key: ${{ runner.os }}-test-macos-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-test-macos-
      
      - name: üß™ Run Tests
        run: |
          TEST_START=$(date +%s)
          xcodebuild test \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-macOS" \
            -sdk macosx \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -destination 'platform=macOS' \
            -derivedDataPath build \
            -only-testing:DisabilityAdvocacyTests \
            2>&1 | tee test-output-macos.txt || exit 1
          
          TEST_END=$(date +%s)
          TEST_DURATION=$((TEST_END - TEST_START))
          echo "‚è±Ô∏è Tests took ${TEST_DURATION}s"
      
      - name: üì§ Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-results
          path: test-output-macos.txt
          retention-days: 7
          compression-level: 6
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          echo "‚è±Ô∏è macOS Tests completed in ${DURATION}s"

  # ============================================================================
  # Gate 10: Post-Build Validation
  # Purpose: Validate build artifacts and code quality metrics
  # ============================================================================
  post-build-validation:
    name: ‚úÖ Post-Build Validation
    runs-on: macos-14
    timeout-minutes: 5
    needs: [build-ios, build-macos]
    if: always()
    steps:
      - name: ‚è±Ô∏è Start Timer
        uses: actions/github-script@v7
        id: timer
        with:
          script: |
            core.exportVariable('WORKFLOW_START', Date.now())
            return Date.now()
      
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ‚úÖ Run Validation Scripts
        run: |
          chmod +x scripts/validate-build.sh scripts/validate-platform-code.sh || true
          ./scripts/validate-build.sh || echo "‚ö†Ô∏è Build validation warnings"
          ./scripts/validate-platform-code.sh || echo "‚ö†Ô∏è Platform validation warnings"
      
      - name: üìä Check Code Metrics
        run: |
          echo "## üìä Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Basic Metrics
          echo "### üìà Basic Metrics" >> $GITHUB_STEP_SUMMARY
          SWIFT_FILES=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" | wc -l | tr -d ' ')
          TOTAL_LINES=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec wc -l {} \; | awk '{s+=$1} END {print s}' || echo "0")
          AVG_LINES_PER_FILE=$([ "$SWIFT_FILES" -gt 0 ] && echo $((TOTAL_LINES / SWIFT_FILES)) || echo "0")
          echo "- **Total Swift Files:** $SWIFT_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Lines of Code:** $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- **Average Lines per File:** $AVG_LINES_PER_FILE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Code Quality Issues
          echo "### ‚ö†Ô∏è Code Quality Issues" >> $GITHUB_STEP_SUMMARY
          FORCE_UNWRAPS=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -not -path "*/Tests/*" -not -path "*/UITests/*" -exec grep -l "\w+!\s*\(\.\|\[\|,\|)\|\]\|\}\|;\)" {} \; 2>/dev/null | wc -l | tr -d ' ' || echo "0")
          PRINT_STATEMENTS=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -not -path "*/Tests/*" -not -path "*/UITests/*" -exec grep -c "print(" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          TODO_COUNT=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "TODO\|FIXME\|XXX\|HACK" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          FORCE_TRY=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -not -path "*/Tests/*" -not -path "*/UITests/*" -exec grep -c "try!" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          echo "- **Force Unwraps:** $FORCE_UNWRAPS files (production code)" >> $GITHUB_STEP_SUMMARY
          echo "- **Print Statements:** $PRINT_STATEMENTS (should use AppLogger)" >> $GITHUB_STEP_SUMMARY
          echo "- **TODO/FIXME/XXX/HACK:** $TODO_COUNT comments" >> $GITHUB_STEP_SUMMARY
          echo "- **Force Try Statements:** $FORCE_TRY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Code Complexity
          echo "### üîç Code Complexity" >> $GITHUB_STEP_SUMMARY
          LONG_FUNCTIONS=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -not -path "*/Tests/*" -not -path "*/UITests/*" -exec awk '/^[[:space:]]*(func|init|var|let)[[:space:]]/ {start=NR; in_func=1} in_func && /^[[:space:]]*}/ {if(NR-start>50) print FILENAME":"start; in_func=0}' {} \; 2>/dev/null | wc -l | tr -d ' ' || echo "0")
          LARGE_FILES=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -not -path "*/Tests/*" -not -path "*/UITests/*" -exec wc -l {} \; 2>/dev/null | awk '$1 > 500 {count++} END {print count+0}' || echo "0")
          DEEP_NESTING=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -not -path "*/Tests/*" -not -path "*/UITests/*" -exec awk '{nesting=gsub(/\{/, ""); nesting-=gsub(/\}/, ""); if(nesting>4) print FILENAME":"NR}' {} \; 2>/dev/null | wc -l | tr -d ' ' || echo "0")
          echo "- **Long Functions (>50 lines):** $LONG_FUNCTIONS" >> $GITHUB_STEP_SUMMARY
          echo "- **Large Files (>500 lines):** $LARGE_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Deep Nesting (>4 levels):** $DEEP_NESTING instances" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Code Patterns
          echo "### üéØ Code Patterns" >> $GITHUB_STEP_SUMMARY
          GUARD_STATEMENTS=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "guard " {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          IF_LET=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "if let\|if var" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          OPTIONAL_CHAINING=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "?\\." {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          NIL_COALESCING=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "??" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          echo "- **Guard Statements:** $GUARD_STATEMENTS (good practice)" >> $GITHUB_STEP_SUMMARY
          echo "- **Optional Binding (if let):** $IF_LET" >> $GITHUB_STEP_SUMMARY
          echo "- **Optional Chaining (?.):** $OPTIONAL_CHAINING" >> $GITHUB_STEP_SUMMARY
          echo "- **Nil Coalescing (??):** $NIL_COALESCING" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Swift 6 Concurrency
          echo "### ‚ö° Swift 6 Concurrency" >> $GITHUB_STEP_SUMMARY
          MAIN_ACTOR=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "@MainActor" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          ASYNC_AWAIT=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "async\|await" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          TASK_USAGE=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "Task {" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          NONISOLATED=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "nonisolated" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          echo "- **@MainActor Annotations:** $MAIN_ACTOR" >> $GITHUB_STEP_SUMMARY
          echo "- **Async/Await Usage:** $ASYNC_AWAIT" >> $GITHUB_STEP_SUMMARY
          echo "- **Task Usage:** $TASK_USAGE" >> $GITHUB_STEP_SUMMARY
          echo "- **Nonisolated Declarations:** $NONISOLATED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Documentation
          echo "### üìù Documentation" >> $GITHUB_STEP_SUMMARY
          DOCUMENTED_FUNCTIONS=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -not -path "*/Tests/*" -exec grep -c "///" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          TOTAL_FUNCTIONS=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -not -path "*/Tests/*" -exec grep -c "^[[:space:]]*func " {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          DOC_COVERAGE=$([ "$TOTAL_FUNCTIONS" -gt 0 ] && echo "scale=1; $DOCUMENTED_FUNCTIONS * 100 / $TOTAL_FUNCTIONS" | bc || echo "0")
          echo "- **Documented Functions:** $DOCUMENTED_FUNCTIONS / $TOTAL_FUNCTIONS" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation Coverage:** ${DOC_COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Deprecated APIs
          echo "### üö´ Deprecated APIs" >> $GITHUB_STEP_SUMMARY
          DEPRECATED=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "@available.*deprecated\|#available.*deprecated" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          DISPATCH_QUEUE=$(find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" -exec grep -c "DispatchQueue\|dispatch_" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          echo "- **Deprecated API Usage:** $DEPRECATED" >> $GITHUB_STEP_SUMMARY
          echo "- **DispatchQueue Usage:** $DISPATCH_QUEUE (consider async/await)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Coverage
          echo "### üß™ Test Coverage" >> $GITHUB_STEP_SUMMARY
          TEST_FILES=$(find . -path "*/Tests/*" -name "*.swift" 2>/dev/null | wc -l | tr -d ' ' || echo "0")
          TEST_FUNCTIONS=$(find . -path "*/Tests/*" -name "*.swift" -exec grep -c "func test" {} \; 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
          echo "- **Test Files:** $TEST_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Functions:** $TEST_FUNCTIONS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Summary
          echo "### üìã Summary" >> $GITHUB_STEP_SUMMARY
          if [ "$FORCE_UNWRAPS" -eq 0 ] && [ "$PRINT_STATEMENTS" -eq 0 ] && [ "$FORCE_TRY" -eq 0 ]; then
            echo "‚úÖ **Excellent code quality!** No critical issues found." >> $GITHUB_STEP_SUMMARY
          elif [ "$FORCE_UNWRAPS" -lt 5 ] && [ "$PRINT_STATEMENTS" -lt 10 ]; then
            echo "‚ö†Ô∏è **Good code quality** with minor issues to address." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Code quality needs improvement.** Consider addressing the issues above." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ‚úÖ Validate Resources
        run: |
          [ -f "Resources/Assets.xcassets/Contents.json" ] || echo "‚ö†Ô∏è Assets.xcassets missing"
          [ -f "Resources/Events.json" ] || echo "‚ö†Ô∏è Events.json missing"
          [ -f "Resources/Resources.json" ] || echo "‚ö†Ô∏è Resources.json missing"
      
      - name: ‚è±Ô∏è Job Duration
        if: always()
        run: |
          DURATION=$(((${{ steps.timer.outputs.result }} - ${{ env.WORKFLOW_START }}) / 1000))
          echo "‚è±Ô∏è Post-Build Validation completed in ${DURATION}s"

  # ============================================================================
  # Gate 11: Build Status Summary
  # Purpose: Generate final status report with performance metrics
  # ============================================================================
  status-summary:
    name: üìä Status Summary
    runs-on: ubuntu-latest
    needs: [build-ios, build-macos, test-ios, test-macos, post-build-validation, security-scan, concurrency-check, code-quality]
    if: always()
    steps:
      - name: üìä Generate Summary
        run: |
          echo "# üöÄ Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Builds" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: ${{ needs.build-macos.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üß™ Tests" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: ${{ needs.test-ios.result == 'skipped' && '‚è≠Ô∏è Skipped' || needs.test-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: ${{ needs.test-macos.result == 'skipped' && '‚è≠Ô∏è Skipped' || needs.test-macos.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result == 'skipped' && '‚è≠Ô∏è Skipped' || needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Post-Build: ${{ needs.post-build-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Concurrency: ${{ needs.concurrency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚ö° Performance Tips" >> $GITHUB_STEP_SUMMARY
          echo "- Cache hits reduce build times significantly" >> $GITHUB_STEP_SUMMARY
          echo "- Parallel jobs run concurrently for faster completion" >> $GITHUB_STEP_SUMMARY
          echo "- Use workflow_dispatch to skip unnecessary steps" >> $GITHUB_STEP_SUMMARY