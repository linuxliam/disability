name: Continuous Integration - Build, Test, and Validate

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration (Debug or Release)'
        required: false
        default: 'Debug'
        type: choice
        options:
          - Debug
          - Release
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean
      skip_lint:
        description: 'Skip code quality checks'
        required: false
        default: false
        type: boolean

env:
  XCODE_VERSION: '15.0'
  SWIFT_VERSION: '5.9'
  CONFIGURATION: ${{ github.event.inputs.configuration || 'Debug' }}
  SKIP_TESTS: ${{ github.event.inputs.skip_tests == 'true' || false }}
  SKIP_LINT: ${{ github.event.inputs.skip_lint == 'true' || false }}

jobs:
  # ============================================================================
  # Code Quality and Linting
  # ============================================================================
  code-quality-and-linting:
    name: ðŸ” Code Quality and Linting
    runs-on: macos-14
    timeout-minutes: 10
    if: github.event.inputs.skip_lint != 'true'
    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure Xcode Version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: ðŸ“¦ Verify SwiftLint Installation
        run: |
          if ! command -v swiftlint &> /dev/null; then
            echo "SwiftLint not found. Install with: brew install swiftlint"
            echo "Skipping linting for now..."
            exit 0
          fi
          swiftlint version
      
      - name: ðŸ§¹ Run SwiftLint Code Analysis
        run: |
          if command -v swiftlint &> /dev/null; then
            swiftlint lint --reporter github-actions-logging || true
          else
            echo "SwiftLint not available, skipping..."
          fi
      
      - name: âœ¨ Validate Swift Code Formatting
        run: |
          echo "Checking Swift code formatting..."
          find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" | while read file; do
            echo "Checking: $file"
          done
          echo "Format check complete (basic validation)"
      
      - name: ðŸ“ Validate Project File Structure
        run: |
          echo "Validating project structure..."
          [ -f "DisabilityAdvocacy.xcodeproj/project.pbxproj" ] || (echo "Missing project.pbxproj" && exit 1)
          [ -f "iOS/Info.plist" ] || (echo "Missing iOS/Info.plist" && exit 1)
          [ -f "macOS/Info.plist" ] || (echo "Missing macOS/Info.plist" && exit 1)
          echo "âœ“ Project structure valid"

  # ============================================================================
  # Project and Dependency Validation
  # ============================================================================
  validate-project-and-dependencies:
    name: âœ… Validate Project and Dependencies
    runs-on: macos-14
    timeout-minutes: 5
    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure Xcode Version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: ðŸ” Validate Xcode Project Structure
        run: |
          xcodebuild -list -project DisabilityAdvocacy.xcodeproj
          echo "âœ“ Project structure valid"
      
      - name: ðŸ”Ž Check for Missing Source Files
        run: |
          echo "Checking for missing source files..."
          xcodebuild -project DisabilityAdvocacy.xcodeproj \
            -target "DisabilityAdvocacy-iOS" \
            -showBuildSettings 2>&1 | grep -i "error" || echo "âœ“ No missing file errors"
      
      - name: ðŸ“‹ Verify Swift Package Dependencies
        run: |
          echo "Checking Swift Package dependencies..."
          if grep -r "packageReferences" DisabilityAdvocacy.xcodeproj/project.pbxproj > /dev/null 2>&1; then
            echo "âœ“ Swift Package dependencies found"
            xcodebuild -resolvePackageDependencies -project DisabilityAdvocacy.xcodeproj || echo "âš ï¸ Package resolution completed with warnings"
          else
            echo "â„¹ï¸ No Swift Package dependencies found"
          fi

  # ============================================================================
  # Swift 6 Concurrency Pre-Check
  # ============================================================================
  swift-6-concurrency-pre-check:
    name: âš¡ Swift 6 Concurrency Pre-Check
    runs-on: macos-14
    timeout-minutes: 10
    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure Xcode Version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: ðŸ” Check for Swift 6 Concurrency Issues
        id: concurrency_check
        run: |
          echo "## ðŸ” Swift 6 Concurrency Pre-Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Pattern 1: Check for calls to MainActor-isolated methods without @MainActor
          echo "### Checking for MainActor isolation issues..." >> $GITHUB_STEP_SUMMARY
          
          CONCURRENCY_ISSUES=0
          
          # Find files that call Manager.shared methods without @MainActor
          while IFS= read -r file; do
            # Check for calls to Manager.shared methods in non-isolated contexts
            if grep -q "Manager\.shared\." "$file" && ! grep -q "@MainActor" "$file"; then
              # Check if the method calling Manager.shared is not marked @MainActor
              LINE_NUM=$(grep -n "Manager\.shared\." "$file" | head -1 | cut -d: -f1)
              if [ -n "$LINE_NUM" ]; then
                # Check if the function containing this line is marked @MainActor
                FUNCTION_START=$(sed -n "1,${LINE_NUM}p" "$file" | grep -nE "^\s*(private\s+)?func\s+" | tail -1 | cut -d: -f1)
                if [ -n "$FUNCTION_START" ]; then
                  FUNCTION_CONTEXT=$(sed -n "${FUNCTION_START},${LINE_NUM}p" "$file")
                  if ! echo "$FUNCTION_CONTEXT" | grep -q "@MainActor"; then
                    echo "âš ï¸ **Potential issue in:** \`$file\` (line $LINE_NUM)" >> $GITHUB_STEP_SUMMARY
                    echo "   Calls Manager.shared method without @MainActor annotation" >> $GITHUB_STEP_SUMMARY
                    CONCURRENCY_ISSUES=$((CONCURRENCY_ISSUES + 1))
                  fi
                fi
              fi
            fi
          done < <(find Shared -name "*.swift" -type f 2>/dev/null)
          
          # Pattern 2: Check for nonisolated init calling MainActor methods
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checking for nonisolated init issues..." >> $GITHUB_STEP_SUMMARY
          
          while IFS= read -r file; do
            if grep -q "nonisolated init" "$file"; then
              # Check if nonisolated init calls MainActor methods
              if grep -A 10 "nonisolated init" "$file" | grep -q "Manager\.shared\|MainActor"; then
                echo "âš ï¸ **Potential issue in:** \`$file\`" >> $GITHUB_STEP_SUMMARY
                echo "   nonisolated init may call MainActor-isolated methods" >> $GITHUB_STEP_SUMMARY
                CONCURRENCY_ISSUES=$((CONCURRENCY_ISSUES + 1))
              fi
            fi
          done < <(find Shared -name "*.swift" -type f 2>/dev/null)
          
          # Summary
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$CONCURRENCY_ISSUES" -eq 0 ]; then
            echo "âœ… **No obvious concurrency issues detected**" >> $GITHUB_STEP_SUMMARY
            echo "Note: This is a pre-check. Full validation occurs during build." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Found $CONCURRENCY_ISSUES potential concurrency issue(s)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ Common Fixes:" >> $GITHUB_STEP_SUMMARY
            echo "1. Add \`@MainActor\` to methods that call MainActor-isolated code" >> $GITHUB_STEP_SUMMARY
            echo "2. Use \`Task { @MainActor in ... }\` for async MainActor calls" >> $GITHUB_STEP_SUMMARY
            echo "3. Use \`MainActor.assumeIsolated { ... }\` in nonisolated init (with caution)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "::notice title=Swift 6 Concurrency Check::Found $CONCURRENCY_ISSUES potential issue(s)"
          
          # Exit with success (this is a warning check, not a blocker)
          exit 0

  # ============================================================================
  # Build iOS Application
  # ============================================================================
  build-ios-application:
    name: ðŸ“± Build iOS Application (${{ matrix.configuration }})
    runs-on: macos-14
    timeout-minutes: 30
    needs: [validate-project-and-dependencies, swift-6-concurrency-pre-check]
    if: always()
    strategy:
      fail-fast: false
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure Xcode Version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: ðŸ“Š Display Xcode and Swift Versions
        run: |
          echo "### Build Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          xcodebuild -version | head -1 >> $GITHUB_STEP_SUMMARY
          swift --version | head -1 >> $GITHUB_STEP_SUMMARY
          xcodebuild -version
          swift --version
      
      - name: ðŸ’¾ Cache Swift Packages and Build Artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            build
          key: ${{ runner.os }}-ios-${{ matrix.configuration }}-${{ hashFiles('**/*.swift', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-ios-${{ matrix.configuration }}-
            ${{ runner.os }}-ios-
            ${{ runner.os }}-
      
      - name: ðŸ“‹ List Available iOS Simulators
        run: xcrun simctl list devices available | head -20
      
      - name: ðŸ”¨ Build iOS Application (${{ matrix.configuration }})
        id: build
        run: |
          set -o pipefail
          xcodebuild \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-iOS" \
            -sdk iphonesimulator \
            -configuration ${{ matrix.configuration }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build \
            clean build \
            2>&1 | tee build-ios-${{ matrix.configuration }}.log
      
      - name: ðŸ“ Extract and Report Build Warnings
        if: always()
        run: |
          if [ -f "build-ios-${{ matrix.configuration }}.log" ]; then
            WARNING_COUNT=$(grep -c "warning:" build-ios-${{ matrix.configuration }}.log || echo "0")
            echo "### Build Warnings (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
            echo "**Total Warnings:** $WARNING_COUNT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "warning:" build-ios-${{ matrix.configuration }}.log | head -20 >> $GITHUB_STEP_SUMMARY || echo "No warnings" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ” Categorize and Report Build Errors
        if: failure()
        run: |
          echo "## âŒ Build Failed (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "build-ios-${{ matrix.configuration }}.log" ]; then
            # Extract and categorize errors
            CONCURRENCY_ERRORS=$(grep -c "main actor-isolated\|nonisolated context" build-ios-${{ matrix.configuration }}.log || echo "0")
            COMPILATION_ERRORS=$(grep -c "error:" build-ios-${{ matrix.configuration }}.log || echo "0")
            LINKER_ERRORS=$(grep -c "Undefined symbol\|ld:" build-ios-${{ matrix.configuration }}.log || echo "0")
            
            echo "### Error Summary" >> $GITHUB_STEP_SUMMARY
            echo "- **Concurrency Errors:** $CONCURRENCY_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Compilation Errors:** $COMPILATION_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Linker Errors:** $LINKER_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show concurrency errors with context
            if [ "$CONCURRENCY_ERRORS" -gt 0 ]; then
              echo "### ðŸ”´ Swift 6 Concurrency Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -B 2 -A 5 "main actor-isolated\|nonisolated context" build-ios-${{ matrix.configuration }}.log | head -50 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**ðŸ’¡ Fix:** Add \`@MainActor\` to the method or use \`Task { @MainActor in ... }\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show other compilation errors
            if [ "$COMPILATION_ERRORS" -gt "$CONCURRENCY_ERRORS" ]; then
              echo "### Other Compilation Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "error:" build-ios-${{ matrix.configuration }}.log | grep -v "main actor-isolated\|nonisolated context" | head -20 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show last 50 lines for context
            echo "### Full Error Context (Last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 build-ios-${{ matrix.configuration }}.log >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Create annotations for better visibility
          if [ -f "build-ios-${{ matrix.configuration }}.log" ]; then
            while IFS= read -r line; do
              if echo "$line" | grep -q "error:"; then
                FILE=$(echo "$line" | grep -oE "[^:]+\.swift" | head -1 || echo "")
                LINE_NUM=$(echo "$line" | grep -oE ":[0-9]+:" | head -1 | tr -d ':' || echo "")
                MESSAGE=$(echo "$line" | sed 's/.*error: //' || echo "$line")
                if [ -n "$FILE" ] && [ -n "$LINE_NUM" ]; then
                  echo "::error file=$FILE,line=$LINE_NUM::$MESSAGE"
                fi
              fi
            done < <(grep "error:" build-ios-${{ matrix.configuration }}.log | head -10)
          fi
      
      - name: âœ… Validate Built Application Bundle
        if: success()
        run: |
          APP_PATH="build/${{ matrix.configuration == 'Debug' && 'Debug' || 'Release' }}-iphonesimulator/DisabilityAdvocacy-iOS.app"
          if [ -d "$APP_PATH" ]; then
            echo "âœ… Application bundle found at: $APP_PATH"
            echo "Bundle size: $(du -sh "$APP_PATH" | cut -f1)"
            # Check for required Info.plist
            if [ -f "$APP_PATH/Info.plist" ]; then
              echo "âœ… Info.plist found in bundle"
            else
              echo "âŒ Info.plist missing from bundle"
              exit 1
            fi
          else
            echo "âŒ Application bundle not found at expected path: $APP_PATH"
            exit 1
          fi
      
      - name: ðŸ“¦ Archive Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts-${{ matrix.configuration }}
          path: |
            build/${{ matrix.configuration == 'Debug' && 'Debug' || 'Release' }}-iphonesimulator/DisabilityAdvocacy-iOS.app
            build-ios-${{ matrix.configuration }}.log
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  # ============================================================================
  # Build macOS Application
  # ============================================================================
  build-macos-application:
    name: ðŸ’» Build macOS Application (${{ matrix.configuration }})
    runs-on: macos-14
    timeout-minutes: 30
    needs: [validate-project-and-dependencies, swift-6-concurrency-pre-check]
    if: always()
    strategy:
      fail-fast: false
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure Xcode Version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: ðŸ“Š Display Xcode and Swift Versions
        run: |
          echo "### Build Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          xcodebuild -version | head -1 >> $GITHUB_STEP_SUMMARY
          swift --version | head -1 >> $GITHUB_STEP_SUMMARY
          xcodebuild -version
          swift --version
      
      - name: ðŸ’¾ Cache Swift Packages and Build Artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            build
          key: ${{ runner.os }}-macos-${{ matrix.configuration }}-${{ hashFiles('**/*.swift', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-macos-${{ matrix.configuration }}-
            ${{ runner.os }}-macos-
            ${{ runner.os }}-
      
      - name: ðŸ”¨ Build macOS Application (${{ matrix.configuration }})
        id: build
        run: |
          set -o pipefail
          xcodebuild \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-macOS" \
            -sdk macosx \
            -configuration ${{ matrix.configuration }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build \
            clean build \
            2>&1 | tee build-macos-${{ matrix.configuration }}.log
      
      - name: ðŸ“ Extract and Report Build Warnings
        if: always()
        run: |
          if [ -f "build-macos-${{ matrix.configuration }}.log" ]; then
            WARNING_COUNT=$(grep -c "warning:" build-macos-${{ matrix.configuration }}.log || echo "0")
            echo "### Build Warnings (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
            echo "**Total Warnings:** $WARNING_COUNT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "warning:" build-macos-${{ matrix.configuration }}.log | head -20 >> $GITHUB_STEP_SUMMARY || echo "No warnings" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ” Categorize and Report Build Errors
        if: failure()
        run: |
          echo "## âŒ Build Failed (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "build-macos-${{ matrix.configuration }}.log" ]; then
            # Extract and categorize errors
            CONCURRENCY_ERRORS=$(grep -c "main actor-isolated\|nonisolated context" build-macos-${{ matrix.configuration }}.log || echo "0")
            COMPILATION_ERRORS=$(grep -c "error:" build-macos-${{ matrix.configuration }}.log || echo "0")
            LINKER_ERRORS=$(grep -c "Undefined symbol\|ld:" build-macos-${{ matrix.configuration }}.log || echo "0")
            
            echo "### Error Summary" >> $GITHUB_STEP_SUMMARY
            echo "- **Concurrency Errors:** $CONCURRENCY_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Compilation Errors:** $COMPILATION_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Linker Errors:** $LINKER_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show concurrency errors with context
            if [ "$CONCURRENCY_ERRORS" -gt 0 ]; then
              echo "### ðŸ”´ Swift 6 Concurrency Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -B 2 -A 5 "main actor-isolated\|nonisolated context" build-macos-${{ matrix.configuration }}.log | head -50 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**ðŸ’¡ Fix:** Add \`@MainActor\` to the method or use \`Task { @MainActor in ... }\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show other compilation errors
            if [ "$COMPILATION_ERRORS" -gt "$CONCURRENCY_ERRORS" ]; then
              echo "### Other Compilation Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "error:" build-macos-${{ matrix.configuration }}.log | grep -v "main actor-isolated\|nonisolated context" | head -20 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show last 50 lines for context
            echo "### Full Error Context (Last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 build-macos-${{ matrix.configuration }}.log >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Create annotations for better visibility
          if [ -f "build-macos-${{ matrix.configuration }}.log" ]; then
            while IFS= read -r line; do
              if echo "$line" | grep -q "error:"; then
                FILE=$(echo "$line" | grep -oE "[^:]+\.swift" | head -1 || echo "")
                LINE_NUM=$(echo "$line" | grep -oE ":[0-9]+:" | head -1 | tr -d ':' || echo "")
                MESSAGE=$(echo "$line" | sed 's/.*error: //' || echo "$line")
                if [ -n "$FILE" ] && [ -n "$LINE_NUM" ]; then
                  echo "::error file=$FILE,line=$LINE_NUM::$MESSAGE"
                fi
              fi
            done < <(grep "error:" build-macos-${{ matrix.configuration }}.log | head -10)
          fi
      
      - name: âœ… Validate Built Application Bundle
        if: success()
        run: |
          APP_PATH="build/${{ matrix.configuration }}/DisabilityAdvocacy-macOS.app"
          if [ -d "$APP_PATH" ]; then
            echo "âœ… Application bundle found at: $APP_PATH"
            echo "Bundle size: $(du -sh "$APP_PATH" | cut -f1)"
            # Check for required Info.plist
            if [ -f "$APP_PATH/Contents/Info.plist" ]; then
              echo "âœ… Info.plist found in bundle"
            else
              echo "âŒ Info.plist missing from bundle"
              exit 1
            fi
          else
            echo "âŒ Application bundle not found at expected path: $APP_PATH"
            exit 1
          fi
      
      - name: ðŸ“¦ Archive Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-artifacts-${{ matrix.configuration }}
          path: |
            build/${{ matrix.configuration }}/DisabilityAdvocacy-macOS.app
            build-macos-${{ matrix.configuration }}.log
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  # ============================================================================
  # Run iOS Unit Tests
  # ============================================================================
  test-ios-application:
    name: ðŸ§ª Test iOS Application (${{ matrix.device }})
    runs-on: macos-14
    timeout-minutes: 25
    needs: [build-ios-application]
    if: always() && github.event.inputs.skip_tests != 'true'
    strategy:
      fail-fast: false
      matrix:
        device: [iPhone 15, iPhone 15 Pro]
    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure Xcode Version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: ðŸ’¾ Cache Test Results and Build Artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build
          key: ${{ runner.os }}-test-ios-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-test-ios-
      
      - name: ðŸ“‹ List Available iOS Simulators
        run: |
          echo "Available iOS Simulators:"
          xcrun simctl list devices available | grep -i "iphone" | head -10
      
      - name: ðŸ” Find and Boot iOS Simulator
        id: simulator
        run: |
          # Try to find the specific device
          DEVICE_NAME="${{ matrix.device }}"
          DEVICE_UDID=$(xcrun simctl list devices available | grep -i "$DEVICE_NAME" | grep -i "iphone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          
          if [ -z "$DEVICE_UDID" ]; then
            # Fallback to any available iPhone simulator
            echo "Device '$DEVICE_NAME' not found, using first available iPhone"
            DEVICE_UDID=$(xcrun simctl list devices available | grep -i "iphone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
            DEVICE_NAME=$(xcrun simctl list devices available | grep -i "iphone" | head -1 | sed -E 's/.*(iPhone[^\(]+).*/\1/' | xargs)
          fi
          
          if [ -z "$DEVICE_UDID" ]; then
            echo "No iPhone simulator found, using generic destination"
            echo "use_generic=true" >> $GITHUB_OUTPUT
            echo "device_name=generic" >> $GITHUB_OUTPUT
          else
            echo "Found device: $DEVICE_NAME ($DEVICE_UDID)"
            echo "use_generic=false" >> $GITHUB_OUTPUT
            echo "device_name=$DEVICE_NAME" >> $GITHUB_OUTPUT
            echo "device_udid=$DEVICE_UDID" >> $GITHUB_OUTPUT
            
            # Boot the simulator
            xcrun simctl boot "$DEVICE_UDID" 2>/dev/null || true
            sleep 5
          fi
      
      - name: ðŸ§ª Execute iOS Unit Tests
        id: test
        run: |
          set -o pipefail
          
          if [ "${{ steps.simulator.outputs.use_generic }}" == "true" ]; then
            DESTINATION="generic/platform=iOS Simulator"
          else
            DESTINATION="platform=iOS Simulator,id=${{ steps.simulator.outputs.device_udid }}"
          fi
          
          echo "Using destination: $DESTINATION"
          
          xcodebuild test \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-iOS" \
            -sdk iphonesimulator \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -destination "$DESTINATION" \
            -derivedDataPath build \
            -resultBundlePath build/test-results-${{ matrix.device }}.xcresult \
            -only-testing:DisabilityAdvocacyTests \
            2>&1 | tee test-output-${{ matrix.device }}.txt || TEST_EXIT_CODE=$?
      
      - name: ðŸ“Š Parse and Report Test Results
        if: always()
        run: |
          if [ -f "test-output-${{ matrix.device }}.txt" ]; then
            echo "## Test Results (${{ matrix.device }})" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Extract test summary
            if grep -q "Test Suite" test-output-${{ matrix.device }}.txt; then
              grep -A 5 "Test Suite" test-output-${{ matrix.device }}.txt | head -20 >> $GITHUB_STEP_SUMMARY || true
            fi
            
            # Extract passed/failed counts
            PASSED=$(grep -oE "[0-9]+ passed" test-output-${{ matrix.device }}.txt | head -1 || echo "0 passed")
            FAILED=$(grep -oE "[0-9]+ failed" test-output-${{ matrix.device }}.txt | head -1 || echo "0 failed")
            
            echo "Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Show failed tests
            if grep -q "failed" test-output-${{ matrix.device }}.txt; then
              echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -E "Test Case.*failed|error:" test-output-${{ matrix.device }}.txt | head -10 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      - name: ðŸ“¦ Archive Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results-${{ matrix.device }}
          path: |
            build/test-results-${{ matrix.device }}.xcresult
            test-output-${{ matrix.device }}.txt
          retention-days: 7
          if-no-files-found: ignore
          compression-level: 6

  # ============================================================================
  # Run macOS Unit Tests
  # ============================================================================
  test-macos-application:
    name: ðŸ§ª Test macOS Application
    runs-on: macos-14
    timeout-minutes: 20
    needs: [build-macos-application]
    if: always() && github.event.inputs.skip_tests != 'true'
    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure Xcode Version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: ðŸ’¾ Cache Test Results and Build Artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build
          key: ${{ runner.os }}-test-macos-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-test-macos-
      
      - name: ðŸ§ª Execute macOS Unit Tests
        id: test
        run: |
          set -o pipefail
          xcodebuild test \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-macOS" \
            -sdk macosx \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -destination 'platform=macOS' \
            -derivedDataPath build \
            -resultBundlePath build/test-results-macos.xcresult \
            -only-testing:DisabilityAdvocacyTests \
            2>&1 | tee test-output-macos.txt || TEST_EXIT_CODE=$?
      
      - name: ðŸ“Š Parse and Report Test Results
        if: always()
        run: |
          if [ -f "test-output-macos.txt" ]; then
            echo "## macOS Test Results" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Extract test summary
            if grep -q "Test Suite" test-output-macos.txt; then
              grep -A 5 "Test Suite" test-output-macos.txt | head -20 >> $GITHUB_STEP_SUMMARY || true
            fi
            
            # Extract passed/failed counts
            PASSED=$(grep -oE "[0-9]+ passed" test-output-macos.txt | head -1 || echo "0 passed")
            FAILED=$(grep -oE "[0-9]+ failed" test-output-macos.txt | head -1 || echo "0 failed")
            
            echo "Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“¦ Archive Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-results
          path: |
            build/test-results-macos.xcresult
            test-output-macos.txt
          retention-days: 7
          if-no-files-found: ignore
          compression-level: 6

  # ============================================================================
  # Comprehensive Build Validation
  # ============================================================================
  comprehensive-build-validation:
    name: âœ… Comprehensive Build Validation
    runs-on: macos-14
    timeout-minutes: 15
    needs: [build-ios-application, build-macos-application]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure Xcode Version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: ðŸ”¨ Run Build Validation Script
        run: |
          chmod +x scripts/validate-build.sh || true
          ./scripts/validate-build.sh || echo "âš ï¸ Build validation completed with warnings"
      
      - name: ðŸ” Run Platform Code Validation Script
        run: |
          chmod +x scripts/validate-platform-code.sh || true
          ./scripts/validate-platform-code.sh || echo "âš ï¸ Platform validation completed with warnings"
      
      - name: ðŸ”Ž Check for Common Code Issues
        run: |
          echo "## Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking for common build issues..." >> $GITHUB_STEP_SUMMARY
          
          # Check for force unwraps
          FORCE_UNWRAPS=$(find . -name "*.swift" -not -path "./build/*" -exec grep -l "!" {} \; | wc -l || echo "0")
          echo "Files with force unwraps: $FORCE_UNWRAPS" >> $GITHUB_STEP_SUMMARY
          
          # Check for print statements (should use logger)
          PRINT_STATEMENTS=$(find . -name "*.swift" -not -path "./build/*" -exec grep -c "print(" {} \; | awk '{s+=$1} END {print s}' || echo "0")
          echo "Print statements found: $PRINT_STATEMENTS" >> $GITHUB_STEP_SUMMARY
          
          # Check for TODO/FIXME
          TODO_COUNT=$(find . -name "*.swift" -not -path "./build/*" -exec grep -c "TODO\|FIXME" {} \; | awk '{s+=$1} END {print s}' || echo "0")
          echo "TODO/FIXME comments: $TODO_COUNT" >> $GITHUB_STEP_SUMMARY
          
          # Check for missing error handling
          TRY_COUNT=$(find . -name "*.swift" -not -path "./build/*" -exec grep -c "try!" {} \; | awk '{s+=$1} END {print s}' || echo "0")
          echo "Force try statements: $TRY_COUNT" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Force unwraps:** $FORCE_UNWRAPS files" >> $GITHUB_STEP_SUMMARY
          echo "- **Print statements:** $PRINT_STATEMENTS" >> $GITHUB_STEP_SUMMARY
          echo "- **TODO/FIXME:** $TODO_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Force try statements:** $TRY_COUNT" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“‹ Validate Project Can Be Opened in Xcode
        run: |
          echo "Validating that project can be opened in Xcode..."
          xcodebuild -list -project DisabilityAdvocacy.xcodeproj > /dev/null
          echo "âœ… Project structure is valid and can be opened in Xcode"
      
      - name: ðŸ” Check for Missing Resources
        run: |
          echo "Checking for missing resources..."
          MISSING_RESOURCES=0
          
          # Check for required asset catalogs
          if [ ! -f "Resources/Assets.xcassets/Contents.json" ]; then
            echo "âš ï¸ Assets.xcassets/Contents.json missing"
            MISSING_RESOURCES=$((MISSING_RESOURCES + 1))
          fi
          
          # Check for required JSON files
          if [ ! -f "Resources/Events.json" ]; then
            echo "âš ï¸ Resources/Events.json missing"
            MISSING_RESOURCES=$((MISSING_RESOURCES + 1))
          fi
          
          if [ ! -f "Resources/Resources.json" ]; then
            echo "âš ï¸ Resources/Resources.json missing"
            MISSING_RESOURCES=$((MISSING_RESOURCES + 1))
          fi
          
          if [ $MISSING_RESOURCES -eq 0 ]; then
            echo "âœ… All required resources found"
          else
            echo "âš ï¸ Found $MISSING_RESOURCES missing resource(s)"
          fi

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security-scanning:
    name: ðŸ”’ Security Scanning
    runs-on: macos-14
    timeout-minutes: 10
    steps:
      - name: ðŸ“¥ Checkout Source Code
        uses: actions/checkout@v4
      
      - name: ðŸ” Scan for Hardcoded Secrets
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scanning for potential secrets..." >> $GITHUB_STEP_SUMMARY
          
          # Check for API keys, tokens, etc.
          SECRET_PATTERNS=("api[_-]?key" "secret" "token" "password" "auth[_-]?token")
          FOUND_SECRETS=0
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            MATCHES=$(grep -r -i "$pattern" --include="*.swift" --include="*.plist" --include="*.json" . 2>/dev/null | grep -v ".git" | grep -v "node_modules" | wc -l || echo "0")
            if [ "$MATCHES" -gt 0 ]; then
              echo "âš ï¸ Found potential secrets matching '$pattern': $MATCHES" >> $GITHUB_STEP_SUMMARY
              FOUND_SECRETS=$((FOUND_SECRETS + MATCHES))
            fi
          done
          
          if [ "$FOUND_SECRETS" -gt 0 ]; then
            echo "âš ï¸ Security scan found $FOUND_SECRETS potential issues" >> $GITHUB_STEP_SUMMARY
            echo "Please review and ensure no secrets are committed." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No obvious secrets found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“¦ Check Dependencies for Vulnerabilities
        run: |
          echo "Checking for dependency vulnerabilities..." >> $GITHUB_STEP_SUMMARY
          echo "Note: For Swift Package Manager, use 'swift package show-dependencies'" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dependency check complete (manual review recommended)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Build Status Summary
  # ============================================================================
  build-status-summary:
    name: ðŸ“Š Build Status Summary
    runs-on: ubuntu-latest
    needs: [build-ios-application, build-macos-application, test-ios-application, test-macos-application, comprehensive-build-validation, security-scanning, swift-6-concurrency-pre-check]
    if: always()
    steps:
      - name: ðŸ“‹ Generate Comprehensive Status Summary
        run: |
          echo "# ðŸš€ Build and Test Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build Status
          echo "## ðŸ“¦ Platform Builds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Configuration | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | Debug | ${{ needs.build-ios-application.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | Release | ${{ needs.build-ios-application.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | Debug | ${{ needs.build-macos-application.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | Release | ${{ needs.build-macos-application.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Status
          echo "## ðŸ§ª Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Unit Tests | ${{ needs.test-ios-application.result == 'success' && 'âœ… Passed' || needs.test-ios-application.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Unit Tests | ${{ needs.test-macos-application.result == 'success' && 'âœ… Passed' || needs.test-macos-application.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Validation Status
          echo "## âœ… Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Swift 6 Concurrency Check | ${{ needs.swift-6-concurrency-pre-check.result == 'success' && 'âœ… Passed' || needs.swift-6-concurrency-pre-check.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Validation | ${{ needs.comprehensive-build-validation.result == 'success' && 'âœ… Passed' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scanning.result == 'success' && 'âœ… Passed' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality-and-linting.result == 'success' && 'âœ… Passed' || needs.code-quality-and-linting.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Metadata
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** ${{ env.CONFIGURATION }}" >> $GITHUB_STEP_SUMMARY
          
          # Overall Status
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-ios-application.result }}" == "success" ] && [ "${{ needs.build-macos-application.result }}" == "success" ]; then
            echo "### âœ… Overall Status: **SUCCESS**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Overall Status: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
