name: Continuous Integration - Build, Test, and Validate

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration (Debug or Release)'
        required: false
        default: 'Debug'
        type: choice
        options:
          - Debug
          - Release
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean
      skip_lint:
        description: 'Skip code quality checks'
        required: false
        default: false
        type: boolean

env:
  XCODE_VERSION: '15.0'
  SWIFT_VERSION: '5.9'
  CONFIGURATION: ${{ github.event.inputs.configuration || 'Debug' }}
  SKIP_TESTS: ${{ github.event.inputs.skip_tests == 'true' || false }}
  SKIP_LINT: ${{ github.event.inputs.skip_lint == 'true' || false }}

jobs:
  # ============================================================================
  # Gate 1: Code Quality Check
  # Purpose: Verify code follows linting standards
  # ============================================================================
  code-quality:
    name: ðŸ” Code Quality Check
    runs-on: macos-14
    timeout-minutes: 5
    if: github.event.inputs.skip_lint != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Run SwiftLint
        run: |
          if command -v swiftlint &> /dev/null; then
            swiftlint lint --reporter github-actions-logging || true
          fi

  # ============================================================================
  # Gate 2: Project Structure Validation
  # Purpose: Verify project files and structure are valid
  # ============================================================================
  validate-project:
    name: âœ… Project Structure Validation
    runs-on: macos-14
    timeout-minutes: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Validate Project
        run: |
          [ -f "DisabilityAdvocacy.xcodeproj/project.pbxproj" ] || exit 1
          [ -f "iOS/Info.plist" ] || exit 1
          [ -f "macOS/Info.plist" ] || exit 1
          xcodebuild -list -project DisabilityAdvocacy.xcodeproj || exit 1

  # ============================================================================
  # Gate 3: Dependency Validation
  # Purpose: Verify all dependencies can be resolved
  # ============================================================================
  validate-dependencies:
    name: ðŸ“¦ Dependency Validation
    runs-on: macos-14
    timeout-minutes: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Resolve Dependencies
        run: |
          if grep -r "packageReferences" DisabilityAdvocacy.xcodeproj/project.pbxproj > /dev/null 2>&1; then
            xcodebuild -resolvePackageDependencies -project DisabilityAdvocacy.xcodeproj || exit 1
          fi

  # ============================================================================
  # Gate 4: Swift 6 Concurrency Pre-Check
  # Purpose: Detect potential concurrency issues before build
  # ============================================================================
  concurrency-check:
    name: âš¡ Swift 6 Concurrency Check
    runs-on: macos-14
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check Concurrency Patterns
        run: |
          CONCURRENCY_ISSUES=0
          while IFS= read -r file; do
            if grep -q "Manager\.shared\." "$file" && ! grep -q "@MainActor" "$file"; then
              CONCURRENCY_ISSUES=$((CONCURRENCY_ISSUES + 1))
            fi
          done < <(find Shared -name "*.swift" -type f 2>/dev/null)
          echo "Found $CONCURRENCY_ISSUES potential concurrency issue(s)"
          exit 0

  # ============================================================================
  # Gate 5: Security Scan
  # Purpose: Check for hardcoded secrets and security issues
  # ============================================================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: macos-14
    timeout-minutes: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Scan for Secrets
        run: |
          SECRET_PATTERNS=("api[_-]?key" "secret" "token" "password")
          for pattern in "${SECRET_PATTERNS[@]}"; do
            grep -r -i "$pattern" --include="*.swift" --include="*.plist" . 2>/dev/null | grep -v ".git" | head -5 || true
          done

  # ============================================================================
  # Gate 6: Build iOS Application
  # Purpose: Compile iOS app for specified configuration
  # ============================================================================
  build-ios:
    name: ðŸ“± Build iOS (${{ matrix.configuration }})
    runs-on: macos-14
    timeout-minutes: 25
    needs: [validate-project, validate-dependencies]
    if: always()
    strategy:
      fail-fast: false
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Cache Build
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            build
          key: ${{ runner.os }}-ios-${{ matrix.configuration }}-${{ hashFiles('**/*.swift', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-ios-${{ matrix.configuration }}-
      
      - name: Build
        run: |
          xcodebuild \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-iOS" \
            -sdk iphonesimulator \
            -configuration ${{ matrix.configuration }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build \
            clean build \
            2>&1 | tee build-ios-${{ matrix.configuration }}.log || exit 1
      
      - name: Validate Bundle
        if: success()
        run: |
          APP_PATH="build/${{ matrix.configuration == 'Debug' && 'Debug' || 'Release' }}-iphonesimulator/DisabilityAdvocacy-iOS.app"
          [ -d "$APP_PATH" ] && [ -f "$APP_PATH/Info.plist" ] || exit 1
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ matrix.configuration }}
          path: |
            build-ios-${{ matrix.configuration }}.log
          retention-days: 7

  # ============================================================================
  # Gate 7: Build macOS Application
  # Purpose: Compile macOS app for specified configuration
  # ============================================================================
  build-macos:
    name: ðŸ’» Build macOS (${{ matrix.configuration }})
    runs-on: macos-14
    timeout-minutes: 25
    needs: [validate-project, validate-dependencies]
    if: always()
    strategy:
      fail-fast: false
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Cache Build
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            build
          key: ${{ runner.os }}-macos-${{ matrix.configuration }}-${{ hashFiles('**/*.swift', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-macos-${{ matrix.configuration }}-
      
      - name: Build
        run: |
          xcodebuild \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-macOS" \
            -sdk macosx \
            -configuration ${{ matrix.configuration }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build \
            clean build \
            2>&1 | tee build-macos-${{ matrix.configuration }}.log || exit 1
      
      - name: Validate Bundle
        if: success()
        run: |
          APP_PATH="build/${{ matrix.configuration }}/DisabilityAdvocacy-macOS.app"
          [ -d "$APP_PATH" ] && [ -f "$APP_PATH/Contents/Info.plist" ] || exit 1
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ matrix.configuration }}
          path: |
            build-macos-${{ matrix.configuration }}.log
          retention-days: 7

  # ============================================================================
  # Gate 8: Test iOS Application
  # Purpose: Execute iOS unit tests
  # ============================================================================
  test-ios:
    name: ðŸ§ª Test iOS (${{ matrix.device }})
    runs-on: macos-14
    timeout-minutes: 20
    needs: [build-ios]
    if: always() && github.event.inputs.skip_tests != 'true'
    strategy:
      fail-fast: false
      matrix:
        device: [iPhone 15, iPhone 15 Pro]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Cache Tests
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build
          key: ${{ runner.os }}-test-ios-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-test-ios-
      
      - name: Find Simulator
        id: simulator
        run: |
          DEVICE_UDID=$(xcrun simctl list devices available | grep -i "${{ matrix.device }}" | grep -i "iphone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          if [ -z "$DEVICE_UDID" ]; then
            DEVICE_UDID=$(xcrun simctl list devices available | grep -i "iphone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          fi
          if [ -z "$DEVICE_UDID" ]; then
            echo "destination=generic/platform=iOS Simulator" >> $GITHUB_OUTPUT
          else
            xcrun simctl boot "$DEVICE_UDID" 2>/dev/null || true
            sleep 3
            echo "destination=platform=iOS Simulator,id=$DEVICE_UDID" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Tests
        run: |
          xcodebuild test \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-iOS" \
            -sdk iphonesimulator \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -destination "${{ steps.simulator.outputs.destination }}" \
            -derivedDataPath build \
            -only-testing:DisabilityAdvocacyTests \
            2>&1 | tee test-output-${{ matrix.device }}.txt || exit 1
      
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-${{ matrix.device }}
          path: test-output-${{ matrix.device }}.txt
          retention-days: 7

  # ============================================================================
  # Gate 9: Test macOS Application
  # Purpose: Execute macOS unit tests
  # ============================================================================
  test-macos:
    name: ðŸ§ª Test macOS
    runs-on: macos-14
    timeout-minutes: 15
    needs: [build-macos]
    if: always() && github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Cache Tests
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build
          key: ${{ runner.os }}-test-macos-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-test-macos-
      
      - name: Run Tests
        run: |
          xcodebuild test \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-macOS" \
            -sdk macosx \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -destination 'platform=macOS' \
            -derivedDataPath build \
            -only-testing:DisabilityAdvocacyTests \
            2>&1 | tee test-output-macos.txt || exit 1
      
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-results
          path: test-output-macos.txt
          retention-days: 7

  # ============================================================================
  # Gate 10: Post-Build Validation
  # Purpose: Validate build artifacts and code quality metrics
  # ============================================================================
  post-build-validation:
    name: âœ… Post-Build Validation
    runs-on: macos-14
    timeout-minutes: 5
    needs: [build-ios, build-macos]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        run: sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Run Validation Scripts
        run: |
          chmod +x scripts/validate-build.sh scripts/validate-platform-code.sh || true
          ./scripts/validate-build.sh || echo "âš ï¸ Build validation warnings"
          ./scripts/validate-platform-code.sh || echo "âš ï¸ Platform validation warnings"
      
      - name: Check Code Metrics
        run: |
          echo "## Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
          FORCE_UNWRAPS=$(find . -name "*.swift" -not -path "./build/*" -exec grep -l "!" {} \; | wc -l || echo "0")
          PRINT_STATEMENTS=$(find . -name "*.swift" -not -path "./build/*" -exec grep -c "print(" {} \; | awk '{s+=$1} END {print s}' || echo "0")
          TODO_COUNT=$(find . -name "*.swift" -not -path "./build/*" -exec grep -c "TODO\|FIXME" {} \; | awk '{s+=$1} END {print s}' || echo "0")
          echo "- Force unwraps: $FORCE_UNWRAPS files" >> $GITHUB_STEP_SUMMARY
          echo "- Print statements: $PRINT_STATEMENTS" >> $GITHUB_STEP_SUMMARY
          echo "- TODO/FIXME: $TODO_COUNT" >> $GITHUB_STEP_SUMMARY
      
      - name: Validate Resources
        run: |
          [ -f "Resources/Assets.xcassets/Contents.json" ] || echo "âš ï¸ Assets.xcassets missing"
          [ -f "Resources/Events.json" ] || echo "âš ï¸ Events.json missing"
          [ -f "Resources/Resources.json" ] || echo "âš ï¸ Resources.json missing"

  # ============================================================================
  # Gate 11: Build Status Summary
  # Purpose: Generate final status report
  # ============================================================================
  status-summary:
    name: ðŸ“Š Status Summary
    runs-on: ubuntu-latest
    needs: [build-ios, build-macos, test-ios, test-macos, post-build-validation, security-scan, concurrency-check]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Builds" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: ${{ needs.build-macos.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tests" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: ${{ needs.test-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: ${{ needs.test-macos.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Post-Build: ${{ needs.post-build-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Concurrency: ${{ needs.concurrency-check.result }}" >> $GITHUB_STEP_SUMMARY
