name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate PR title
        id: title-check
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          
          # Check for conventional commit format
          if echo "$TITLE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "✅ PR title follows conventional commits format"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "❌ PR title should follow conventional commits format: type(scope): description"
            echo "Examples:"
            echo "  feat: add new feature"
            echo "  fix: resolve bug"
            echo "  docs: update documentation"
            exit 1
          fi
      
      - name: Check for linked issue
        id: issue-check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title;
            
            // Check for issue references
            const issuePattern = /(?:closes?|fixes?|resolves?)\s*#(\d+)/gi;
            const matches = [...prBody.matchAll(issuePattern)];
            const titleMatches = [...prTitle.matchAll(issuePattern)];
            
            const allMatches = [...matches, ...titleMatches];
            const issueNumbers = [...new Set(allMatches.map(m => m[1]))];
            
            if (issueNumbers.length > 0) {
              console.log(`✅ PR references issue(s): ${issueNumbers.join(', #')}`);
              core.setOutput('has_issue', 'true');
              core.setOutput('issue_numbers', issueNumbers.join(','));
            } else {
              console.log('⚠️  PR does not reference an issue');
              core.setOutput('has_issue', 'false');
            }
      
      - name: Check PR description
        id: description-check
        run: |
          BODY="${{ github.event.pull_request.body }}"
          
          if [ -z "$BODY" ] || [ "$BODY" == "null" ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "❌ PR description is empty"
            exit 1
          fi
          
          # Check minimum length
          if [ ${#BODY} -lt 50 ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "⚠️  PR description is too short (minimum 50 characters)"
          else
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "✅ PR description is present"
          fi
      
      - name: Check for breaking changes
        id: breaking-check
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"
          
          if echo "$TITLE" | grep -qE '^[^:]+!:' || echo "$BODY" | grep -qiE 'breaking change|BREAKING'; then
            echo "has_breaking=true" >> $GITHUB_OUTPUT
            echo "⚠️  PR contains breaking changes"
          else
            echo "has_breaking=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment PR validation results
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const titleValid = '${{ steps.title-check.outputs.valid }}' === 'true';
            const hasIssue = '${{ steps.issue-check.outputs.has_issue }}' === 'true';
            const descValid = '${{ steps.description-check.outputs.valid }}' === 'true';
            const hasBreaking = '${{ steps.breaking-check.outputs.has_breaking }}' === 'true';
            
            let status = '✅';
            let issues = [];
            
            if (!titleValid) {
              issues.push('❌ PR title does not follow conventional commits format');
              status = '⚠️';
            }
            
            if (!hasIssue) {
              issues.push('⚠️  PR does not reference an issue (consider adding "Fixes #X")');
            }
            
            if (!descValid) {
              issues.push('❌ PR description is missing or too short');
              status = '❌';
            }
            
            if (hasBreaking) {
              issues.push('⚠️  PR contains breaking changes - ensure this is intentional');
            }
            
            const body = `## PR Validation Results
            ${status} **Status:** ${titleValid && descValid ? 'Passed' : 'Needs Attention'}
            
            ### Checks
            ${issues.length > 0 ? issues.map(i => `- ${i}`).join('\n') : '- ✅ All checks passed'}
            
            ### Guidelines
            - Use conventional commits format: \`type(scope): description\`
            - Link to related issues: \`Fixes #X\`
            - Provide detailed description of changes
            - Mark breaking changes with \`!\` or \`BREAKING CHANGE\`
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Validation Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
            
            // Set job status
            if (!titleValid || !descValid) {
              core.setFailed('PR validation failed');
            }
