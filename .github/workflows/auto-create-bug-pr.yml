name: Auto-Create PR for Bug Issues

on:
  issues:
    types: [labeled]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  create-bug-pr:
    name: Create PR for Bug Issue
    runs-on: ubuntu-latest
    if: github.event.label.name == 'bug' && github.event.action == 'labeled'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Check if PR already exists
        id: check-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            
            // Check if any PR references this issue
            const { data: allPrs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const hasPr = allPrs.some(pr => 
              pr.body && (pr.body.includes(`#${issueNumber}`) || 
                         pr.body.includes(`Closes #${issueNumber}`) ||
                         pr.body.includes(`Fixes #${issueNumber}`))
            );
            
            core.setOutput('hasPr', hasPr);
            return hasPr;
      
      - name: Check if branch already exists
        id: check-branch
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          BRANCH_NAME="fix/$ISSUE_NUM/bug-fix"
          
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: Create branch and initial commit
        if: steps.check-pr.outputs.hasPr == 'false' && steps.check-branch.outputs.exists == 'false'
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          BRANCH_NAME="${{ steps.check-branch.outputs.branch }}"
          
          # Switch to main branch
          git checkout main || git checkout -b main origin/main
          git pull origin main || true
          
          # Create new branch
          git checkout -b "$BRANCH_NAME"
          
          # Create placeholder file to establish branch
          mkdir -p .github/auto-fix
          cat > .github/auto-fix/issue-$ISSUE_NUM.md << EOF
# Bug Fix for Issue #$ISSUE_NUM

This PR was automatically created for bug issue #$ISSUE_NUM.

## Issue
- **Title:** ${{ github.event.issue.title }}
- **Number:** #$ISSUE_NUM

## Next Steps
1. Implement the bug fix
2. Add tests if applicable
3. Update documentation if needed
4. Ensure all CI/CD checks pass

## Related
Fixes #$ISSUE_NUM
EOF
          
          # Commit the placeholder
          git add .github/auto-fix/issue-$ISSUE_NUM.md
          git commit -m "fix(issue-$ISSUE_NUM): create branch for bug fix

Automatically created for bug issue #$ISSUE_NUM

Related: #$ISSUE_NUM"
          
          # Push branch
          git push -u origin "$BRANCH_NAME"
      
      - name: Create Pull Request
        if: steps.check-pr.outputs.hasPr == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title;
            const branchName = `fix/${issueNumber}/bug-fix`;
            
            // Check if PR already exists
            const { data: existingPrs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });
            
            if (existingPrs.length > 0) {
              console.log(`PR already exists: #${existingPrs[0].number}`);
              return;
            }
            
            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `fix: ${issueTitle} (Issue #${issueNumber})`,
              head: branchName,
              base: 'main',
              body: `## Description

This PR was automatically created for bug issue #${issueNumber}.

## Issue Details
- **Title:** ${issueTitle}
- **Number:** #${issueNumber}
- **Labels:** ${context.payload.issue.labels.map(l => l.name).join(', ')}

## Status
ðŸš§ **Work in Progress** - This PR was automatically created. Please implement the fix.

## Next Steps
1. [ ] Investigate the bug
2. [ ] Implement the fix
3. [ ] Add tests (if applicable)
4. [ ] Update documentation (if needed)
5. [ ] Ensure all CI/CD checks pass
6. [ ] Request review when ready

## Related
Fixes #${issueNumber}

---
*This PR was automatically created by GitHub Actions when issue #${issueNumber} was labeled as "bug".*`,
              draft: true
            });
            
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);
            
            // Add comment to issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âœ… **PR automatically created**

A pull request has been created for this bug:

ðŸ”— **PR #${pr.number}:** [${pr.title}](${pr.html_url})

The PR is currently in draft mode. Please implement the fix and mark it as ready for review when complete.`
            });
      
      - name: Summary
        if: always()
        run: |
          echo "## Auto-Create PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue:** #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Label:** ${{ github.event.label.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.check-branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Exists:** ${{ steps.check-pr.outputs.hasPr }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch Exists:** ${{ steps.check-branch.outputs.exists }}" >> $GITHUB_STEP_SUMMARY
