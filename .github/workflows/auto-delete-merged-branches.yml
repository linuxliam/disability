name: Auto Delete Merged Branches

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  delete-merged-branch:
    name: üóëÔ∏è Delete Merged Branch
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üóëÔ∏è Delete Merged Branch
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          REPO="${{ github.repository }}"
          
          # Skip deletion for protected branches
          PROTECTED_BRANCHES=("main" "master" "develop")
          
          for protected in "${PROTECTED_BRANCHES[@]}"; do
            if [[ "$BRANCH_NAME" == "$protected" ]]; then
              echo "‚ö†Ô∏è  Skipping deletion of protected branch: $BRANCH_NAME"
              exit 0
            fi
          done
          
          # Skip deletion for release and hotfix branches
          if [[ "$BRANCH_NAME" =~ ^release/ ]] || [[ "$BRANCH_NAME" =~ ^hotfix/ ]]; then
            echo "‚ö†Ô∏è  Skipping deletion of release/hotfix branch: $BRANCH_NAME"
            exit 0
          fi
          
          # Delete the branch using GitHub API
          echo "üóëÔ∏è  Deleting merged branch: $BRANCH_NAME"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X DELETE \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/git/refs/heads/$BRANCH_NAME")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "204" ]; then
            echo "‚úÖ Successfully deleted remote branch: $BRANCH_NAME"
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "‚ÑπÔ∏è  Branch already deleted or doesn't exist: $BRANCH_NAME"
          else
            echo "‚ö†Ô∏è  Failed to delete branch (HTTP $HTTP_CODE): $BRANCH_NAME"
            echo "Response: $BODY"
            exit 1
          fi
