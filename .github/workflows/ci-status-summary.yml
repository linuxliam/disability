name: CI - Status Summary

on:
  workflow_run:
    workflows: 
      - "CI - Build iOS"
      - "CI - Build macOS"
      - "CI - Test iOS"
      - "CI - Test macOS"
      - "CI - Post-Build Validation"
      - "CI - Security Scan"
      - "CI - Code Quality"
    types:
      - completed
  workflow_dispatch:

jobs:
  status-summary:
    name: ðŸ“Š Status Summary
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'cancelled'
    steps:
      - name: ðŸ“Š Generate Summary
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = [
              'CI - Build iOS',
              'CI - Build macOS',
              'CI - Test iOS',
              'CI - Test macOS',
              'CI - Post-Build Validation',
              'CI - Security Scan',
              'CI - Code Quality'
            ];
            
            const runId = context.payload.workflow_run?.id;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            let summary = "# ðŸš€ Build Status\n\n";
            summary += "## ðŸ“¦ Builds\n";
            summary += "- iOS: Check individual workflow\n";
            summary += "- macOS: Check individual workflow\n";
            summary += "\n";
            summary += "## ðŸ§ª Tests\n";
            summary += "- iOS: Check individual workflow\n";
            summary += "- macOS: Check individual workflow\n";
            summary += "\n";
            summary += "## âœ… Validation\n";
            summary += "- Code Quality: Check individual workflow\n";
            summary += "- Post-Build: Check individual workflow\n";
            summary += "- Security: Check individual workflow\n";
            summary += "\n";
            summary += "## âš¡ Performance Tips\n";
            summary += "- Cache hits reduce build times significantly\n";
            summary += "- Parallel jobs run concurrently for faster completion\n";
            summary += "- Use workflow_dispatch to skip unnecessary steps\n";
            summary += "\n";
            summary += "## ðŸ”— Individual Workflows\n";
            
            for (const workflow of workflows) {
              summary += `- [${workflow}](https://github.com/${owner}/${repo}/actions/workflows/${workflow.replace(/\s+/g, '-').toLowerCase()}.yml)\n`;
            }
            
            core.summary = summary;
            
            // Try to find the triggering workflow run
            if (runId) {
              const run = await github.rest.actions.getWorkflowRun({
                owner,
                repo,
                run_id: runId,
              });
              
              console.log(`Workflow: ${run.data.name}`);
              console.log(`Status: ${run.data.status}`);
              console.log(`Conclusion: ${run.data.conclusion}`);
            }
