name: CI - Status Summary

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  status-summary:
    name: ðŸ“Š Status Summary
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ“Š Generate Summary
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = [
              { name: 'CI - Build iOS', file: 'ci-build-ios.yml' },
              { name: 'CI - Build macOS', file: 'ci-build-macos.yml' },
              { name: 'CI - Test iOS', file: 'ci-test-ios.yml' },
              { name: 'CI - Test macOS', file: 'ci-test-macos.yml' },
              { name: 'CI - Post-Build Validation', file: 'ci-post-build-validation.yml' },
              { name: 'CI - Security Scan', file: 'ci-security-scan.yml' },
              { name: 'CI - Code Quality', file: 'ci-code-quality.yml' }
            ];
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            const ref = context.ref;
            
            let summary = "# ðŸš€ Build Status Summary\n\n";
            summary += `**Commit:** ${sha.substring(0, 7)}\n`;
            summary += `**Branch:** ${ref.replace('refs/heads/', '')}\n\n`;
            
            summary += "## ðŸ“¦ Builds\n";
            summary += "- **iOS:** Check [CI - Build iOS](https://github.com/${owner}/${repo}/actions/workflows/ci-build-ios.yml) workflow\n";
            summary += "- **macOS:** Check [CI - Build macOS](https://github.com/${owner}/${repo}/actions/workflows/ci-build-macos.yml) workflow\n";
            summary += "\n";
            
            summary += "## ðŸ§ª Tests\n";
            summary += "- **iOS:** Check [CI - Test iOS](https://github.com/${owner}/${repo}/actions/workflows/ci-test-ios.yml) workflow\n";
            summary += "- **macOS:** Check [CI - Test macOS](https://github.com/${owner}/${repo}/actions/workflows/ci-test-macos.yml) workflow\n";
            summary += "\n";
            
            summary += "## âœ… Validation\n";
            summary += "- **Code Quality:** Check [CI - Code Quality](https://github.com/${owner}/${repo}/actions/workflows/ci-code-quality.yml) workflow\n";
            summary += "- **Post-Build:** Check [CI - Post-Build Validation](https://github.com/${owner}/${repo}/actions/workflows/ci-post-build-validation.yml) workflow\n";
            summary += "- **Security:** Check [CI - Security Scan](https://github.com/${owner}/${repo}/actions/workflows/ci-security-scan.yml) workflow\n";
            summary += "\n";
            
            summary += "## âš¡ Performance Tips\n";
            summary += "- Cache hits reduce build times significantly\n";
            summary += "- Parallel jobs run concurrently for faster completion\n";
            summary += "- Use workflow_dispatch to skip unnecessary steps\n";
            summary += "\n";
            
            summary += "## ðŸ”— All CI Workflows\n";
            for (const workflow of workflows) {
              const workflowUrl = `https://github.com/${owner}/${repo}/actions/workflows/${workflow.file}`;
              summary += `- [${workflow.name}](${workflowUrl})\n`;
            }
            
            // Try to get recent workflow runs
            try {
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                per_page: 10,
              });
              
              summary += "\n## ðŸ“Š Recent Workflow Runs\n";
              summary += "| Workflow | Status | Conclusion |\n";
              summary += "|----------|--------|------------|\n";
              
              for (const run of runs.data.workflow_runs.slice(0, 7)) {
                const status = run.status;
                const conclusion = run.conclusion || 'pending';
                const workflowName = run.name;
                const runUrl = run.html_url;
                summary += `| [${workflowName}](${runUrl}) | ${status} | ${conclusion} |\n`;
              }
            } catch (error) {
              console.log('Could not fetch workflow runs:', error.message);
            }
            
            core.summary = summary;
