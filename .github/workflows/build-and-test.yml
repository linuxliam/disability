name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: false
        default: 'Debug'
        type: choice
        options:
          - Debug
          - Release
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean
      skip_lint:
        description: 'Skip linting'
        required: false
        default: false
        type: boolean

env:
  XCODE_VERSION: '15.0'
  SWIFT_VERSION: '5.9'
  CONFIGURATION: ${{ github.event.inputs.configuration || 'Debug' }}
  SKIP_TESTS: ${{ github.event.inputs.skip_tests == 'true' || false }}
  SKIP_LINT: ${{ github.event.inputs.skip_lint == 'true' || false }}

jobs:
  # Code Quality Checks
  lint:
    name: Code Quality Checks
    runs-on: macos-14
    timeout-minutes: 10
    if: github.event.inputs.skip_lint != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: Install SwiftLint (if needed)
        run: |
          if ! command -v swiftlint &> /dev/null; then
            echo "SwiftLint not found. Install with: brew install swiftlint"
            echo "Skipping linting for now..."
            exit 0
          fi
          swiftlint version
      
      - name: Run SwiftLint
        run: |
          if command -v swiftlint &> /dev/null; then
            swiftlint lint --reporter github-actions-logging || true
          else
            echo "SwiftLint not available, skipping..."
          fi
      
      - name: Check Swift formatting
        run: |
          echo "Checking Swift code formatting..."
          find . -name "*.swift" -not -path "./build/*" -not -path "./.build/*" | while read file; do
            echo "Checking: $file"
          done
          echo "Format check complete (basic validation)"
      
      - name: Validate file structure
        run: |
          echo "Validating project structure..."
          [ -f "DisabilityAdvocacy.xcodeproj/project.pbxproj" ] || (echo "Missing project.pbxproj" && exit 1)
          [ -f "iOS/Info.plist" ] || (echo "Missing iOS/Info.plist" && exit 1)
          [ -f "macOS/Info.plist" ] || (echo "Missing macOS/Info.plist" && exit 1)
          echo "âœ“ Project structure valid"

  # Dependency Validation
  validate-dependencies:
    name: Validate Dependencies
    runs-on: macos-14
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: Validate Xcode project
        run: |
          xcodebuild -list -project DisabilityAdvocacy.xcodeproj
          echo "âœ“ Project structure valid"
      
      - name: Check for missing files
        run: |
          echo "Checking for missing source files..."
          xcodebuild -project DisabilityAdvocacy.xcodeproj \
            -target "DisabilityAdvocacy-iOS" \
            -showBuildSettings 2>&1 | grep -i "error" || echo "âœ“ No missing file errors"

  # Swift 6 Concurrency Pre-Check
  check-swift-concurrency:
    name: Swift 6 Concurrency Check
    runs-on: macos-14
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: Check for Swift 6 concurrency issues
        id: concurrency_check
        run: |
          echo "## ðŸ” Swift 6 Concurrency Pre-Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Pattern 1: Check for calls to MainActor-isolated methods without @MainActor
          echo "### Checking for MainActor isolation issues..." >> $GITHUB_STEP_SUMMARY
          
          CONCURRENCY_ISSUES=0
          
          # Find files that call Manager.shared methods without @MainActor
          while IFS= read -r file; do
            # Check for calls to Manager.shared methods in non-isolated contexts
            if grep -q "Manager\.shared\." "$file" && ! grep -q "@MainActor" "$file"; then
              # Check if the method calling Manager.shared is not marked @MainActor
              LINE_NUM=$(grep -n "Manager\.shared\." "$file" | head -1 | cut -d: -f1)
              if [ -n "$LINE_NUM" ]; then
                # Check if the function containing this line is marked @MainActor
                FUNCTION_START=$(sed -n "1,${LINE_NUM}p" "$file" | grep -nE "^\s*(private\s+)?func\s+" | tail -1 | cut -d: -f1)
                if [ -n "$FUNCTION_START" ]; then
                  FUNCTION_CONTEXT=$(sed -n "${FUNCTION_START},${LINE_NUM}p" "$file")
                  if ! echo "$FUNCTION_CONTEXT" | grep -q "@MainActor"; then
                    echo "âš ï¸ **Potential issue in:** \`$file\` (line $LINE_NUM)" >> $GITHUB_STEP_SUMMARY
                    echo "   Calls Manager.shared method without @MainActor annotation" >> $GITHUB_STEP_SUMMARY
                    CONCURRENCY_ISSUES=$((CONCURRENCY_ISSUES + 1))
                  fi
                fi
              fi
            fi
          done < <(find Shared -name "*.swift" -type f 2>/dev/null)
          
          # Pattern 2: Check for nonisolated init calling MainActor methods
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checking for nonisolated init issues..." >> $GITHUB_STEP_SUMMARY
          
          while IFS= read -r file; do
            if grep -q "nonisolated init" "$file"; then
              # Check if nonisolated init calls MainActor methods
              if grep -A 10 "nonisolated init" "$file" | grep -q "Manager\.shared\|MainActor"; then
                echo "âš ï¸ **Potential issue in:** \`$file\`" >> $GITHUB_STEP_SUMMARY
                echo "   nonisolated init may call MainActor-isolated methods" >> $GITHUB_STEP_SUMMARY
                CONCURRENCY_ISSUES=$((CONCURRENCY_ISSUES + 1))
              fi
            fi
          done < <(find Shared -name "*.swift" -type f 2>/dev/null)
          
          # Summary
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$CONCURRENCY_ISSUES" -eq 0 ]; then
            echo "âœ… **No obvious concurrency issues detected**" >> $GITHUB_STEP_SUMMARY
            echo "Note: This is a pre-check. Full validation occurs during build." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Found $CONCURRENCY_ISSUES potential concurrency issue(s)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ Common Fixes:" >> $GITHUB_STEP_SUMMARY
            echo "1. Add \`@MainActor\` to methods that call MainActor-isolated code" >> $GITHUB_STEP_SUMMARY
            echo "2. Use \`Task { @MainActor in ... }\` for async MainActor calls" >> $GITHUB_STEP_SUMMARY
            echo "3. Use \`MainActor.assumeIsolated { ... }\` in nonisolated init (with caution)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "::notice title=Swift 6 Concurrency Check::Found $CONCURRENCY_ISSUES potential issue(s)"
          
          # Exit with success (this is a warning check, not a blocker)
          exit 0

  # Build Jobs with Matrix Strategy
  build-ios:
    name: Build iOS (${{ matrix.configuration }})
    runs-on: macos-14
    timeout-minutes: 30
    needs: [validate-dependencies, check-swift-concurrency]
    if: always()
    strategy:
      fail-fast: false
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Show Swift version
        run: swift --version
      
      - name: Cache Swift packages and DerivedData
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            build
          key: ${{ runner.os }}-ios-${{ matrix.configuration }}-${{ hashFiles('**/*.swift', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-ios-${{ matrix.configuration }}-
            ${{ runner.os }}-ios-
            ${{ runner.os }}-
      
      - name: List available simulators
        run: xcrun simctl list devices available | head -20
      
      - name: Build iOS target (${{ matrix.configuration }})
        id: build
        run: |
          set -o pipefail
          xcodebuild \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-iOS" \
            -sdk iphonesimulator \
            -configuration ${{ matrix.configuration }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build \
            clean build \
            2>&1 | tee build-ios-${{ matrix.configuration }}.log
      
      - name: Extract build warnings
        if: always()
        run: |
          if [ -f "build-ios-${{ matrix.configuration }}.log" ]; then
            echo "### Build Warnings (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "warning:" build-ios-${{ matrix.configuration }}.log | head -20 >> $GITHUB_STEP_SUMMARY || echo "No warnings" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Categorize and report errors
        if: failure()
        run: |
          echo "## âŒ Build Failed (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "build-ios-${{ matrix.configuration }}.log" ]; then
            # Extract and categorize errors
            CONCURRENCY_ERRORS=$(grep -c "main actor-isolated\|nonisolated context" build-ios-${{ matrix.configuration }}.log || echo "0")
            COMPILATION_ERRORS=$(grep -c "error:" build-ios-${{ matrix.configuration }}.log || echo "0")
            LINKER_ERRORS=$(grep -c "Undefined symbol\|ld:" build-ios-${{ matrix.configuration }}.log || echo "0")
            
            echo "### Error Summary" >> $GITHUB_STEP_SUMMARY
            echo "- **Concurrency Errors:** $CONCURRENCY_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Compilation Errors:** $COMPILATION_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Linker Errors:** $LINKER_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show concurrency errors with context
            if [ "$CONCURRENCY_ERRORS" -gt 0 ]; then
              echo "### ðŸ”´ Swift 6 Concurrency Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -B 2 -A 5 "main actor-isolated\|nonisolated context" build-ios-${{ matrix.configuration }}.log | head -50 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**ðŸ’¡ Fix:** Add \`@MainActor\` to the method or use \`Task { @MainActor in ... }\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show other compilation errors
            if [ "$COMPILATION_ERRORS" -gt "$CONCURRENCY_ERRORS" ]; then
              echo "### Other Compilation Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "error:" build-ios-${{ matrix.configuration }}.log | grep -v "main actor-isolated\|nonisolated context" | head -20 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show last 50 lines for context
            echo "### Full Error Context (Last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 build-ios-${{ matrix.configuration }}.log >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Create annotations for better visibility
          if [ -f "build-ios-${{ matrix.configuration }}.log" ]; then
            while IFS= read -r line; do
              if echo "$line" | grep -q "error:"; then
                FILE=$(echo "$line" | grep -oE "[^:]+\.swift" | head -1 || echo "")
                LINE_NUM=$(echo "$line" | grep -oE ":[0-9]+:" | head -1 | tr -d ':' || echo "")
                MESSAGE=$(echo "$line" | sed 's/.*error: //' || echo "$line")
                if [ -n "$FILE" ] && [ -n "$LINE_NUM" ]; then
                  echo "::error file=$FILE,line=$LINE_NUM::$MESSAGE"
                fi
              fi
            done < <(grep "error:" build-ios-${{ matrix.configuration }}.log | head -10)
          fi
      
      - name: Archive build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ matrix.configuration }}
          path: |
            build/${{ matrix.configuration == 'Debug' && 'Debug' || 'Release' }}-iphonesimulator/DisabilityAdvocacy-iOS.app
            build-ios-${{ matrix.configuration }}.log
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  build-macos:
    name: Build macOS (${{ matrix.configuration }})
    runs-on: macos-14
    timeout-minutes: 30
    needs: [validate-dependencies, check-swift-concurrency]
    if: always()
    strategy:
      fail-fast: false
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Show Swift version
        run: swift --version
      
      - name: Cache Swift packages and DerivedData
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
            build
          key: ${{ runner.os }}-macos-${{ matrix.configuration }}-${{ hashFiles('**/*.swift', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-macos-${{ matrix.configuration }}-
            ${{ runner.os }}-macos-
            ${{ runner.os }}-
      
      - name: Build macOS target (${{ matrix.configuration }})
        id: build
        run: |
          set -o pipefail
          xcodebuild \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-macOS" \
            -sdk macosx \
            -configuration ${{ matrix.configuration }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build \
            clean build \
            2>&1 | tee build-macos-${{ matrix.configuration }}.log
      
      - name: Extract build warnings
        if: always()
        run: |
          if [ -f "build-macos-${{ matrix.configuration }}.log" ]; then
            echo "### Build Warnings (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "warning:" build-macos-${{ matrix.configuration }}.log | head -20 >> $GITHUB_STEP_SUMMARY || echo "No warnings" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Categorize and report errors
        if: failure()
        run: |
          echo "## âŒ Build Failed (${{ matrix.configuration }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "build-macos-${{ matrix.configuration }}.log" ]; then
            # Extract and categorize errors
            CONCURRENCY_ERRORS=$(grep -c "main actor-isolated\|nonisolated context" build-macos-${{ matrix.configuration }}.log || echo "0")
            COMPILATION_ERRORS=$(grep -c "error:" build-macos-${{ matrix.configuration }}.log || echo "0")
            LINKER_ERRORS=$(grep -c "Undefined symbol\|ld:" build-macos-${{ matrix.configuration }}.log || echo "0")
            
            echo "### Error Summary" >> $GITHUB_STEP_SUMMARY
            echo "- **Concurrency Errors:** $CONCURRENCY_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Compilation Errors:** $COMPILATION_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Linker Errors:** $LINKER_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show concurrency errors with context
            if [ "$CONCURRENCY_ERRORS" -gt 0 ]; then
              echo "### ðŸ”´ Swift 6 Concurrency Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -B 2 -A 5 "main actor-isolated\|nonisolated context" build-macos-${{ matrix.configuration }}.log | head -50 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**ðŸ’¡ Fix:** Add \`@MainActor\` to the method or use \`Task { @MainActor in ... }\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show other compilation errors
            if [ "$COMPILATION_ERRORS" -gt "$CONCURRENCY_ERRORS" ]; then
              echo "### Other Compilation Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "error:" build-macos-${{ matrix.configuration }}.log | grep -v "main actor-isolated\|nonisolated context" | head -20 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show last 50 lines for context
            echo "### Full Error Context (Last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 build-macos-${{ matrix.configuration }}.log >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Create annotations for better visibility
          if [ -f "build-macos-${{ matrix.configuration }}.log" ]; then
            while IFS= read -r line; do
              if echo "$line" | grep -q "error:"; then
                FILE=$(echo "$line" | grep -oE "[^:]+\.swift" | head -1 || echo "")
                LINE_NUM=$(echo "$line" | grep -oE ":[0-9]+:" | head -1 | tr -d ':' || echo "")
                MESSAGE=$(echo "$line" | sed 's/.*error: //' || echo "$line")
                if [ -n "$FILE" ] && [ -n "$LINE_NUM" ]; then
                  echo "::error file=$FILE,line=$LINE_NUM::$MESSAGE"
                fi
              fi
            done < <(grep "error:" build-macos-${{ matrix.configuration }}.log | head -10)
          fi
      
      - name: Archive build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ matrix.configuration }}
          path: |
            build/${{ matrix.configuration }}/DisabilityAdvocacy-macOS.app
            build-macos-${{ matrix.configuration }}.log
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

  # Test Jobs
  test-ios:
    name: Test iOS (${{ matrix.device }})
    runs-on: macos-14
    timeout-minutes: 25
    needs: [build-ios]
    if: always() && github.event.inputs.skip_tests != 'true'
    strategy:
      fail-fast: false
      matrix:
        device: [iPhone 15, iPhone 15 Pro]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: Cache test results
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build
          key: ${{ runner.os }}-test-ios-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-test-ios-
      
      - name: Boot iOS Simulator
        run: |
          xcrun simctl boot "${{ matrix.device }}" 2>/dev/null || true
          xcrun simctl list devices | grep "${{ matrix.device }}" || echo "Simulator not found, will use generic"
      
      - name: Run iOS unit tests
        id: test
        run: |
          set -o pipefail
          xcodebuild test \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-iOS" \
            -sdk iphonesimulator \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -destination 'platform=iOS Simulator,name=${{ matrix.device }},OS=latest' \
            -derivedDataPath build \
            -resultBundlePath build/test-results-${{ matrix.device }}.xcresult \
            -only-testing:DisabilityAdvocacyTests \
            2>&1 | tee test-output-${{ matrix.device }}.txt || TEST_EXIT_CODE=$?
      
      - name: Parse test results
        if: always()
        run: |
          if [ -f "test-output-${{ matrix.device }}.txt" ]; then
            echo "## Test Results (${{ matrix.device }})" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Extract test summary
            if grep -q "Test Suite" test-output-${{ matrix.device }}.txt; then
              grep -A 5 "Test Suite" test-output-${{ matrix.device }}.txt | head -20 >> $GITHUB_STEP_SUMMARY || true
            fi
            
            # Extract passed/failed counts
            PASSED=$(grep -oE "[0-9]+ passed" test-output-${{ matrix.device }}.txt | head -1 || echo "0 passed")
            FAILED=$(grep -oE "[0-9]+ failed" test-output-${{ matrix.device }}.txt | head -1 || echo "0 failed")
            
            echo "Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Show failed tests
            if grep -q "failed" test-output-${{ matrix.device }}.txt; then
              echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -E "Test Case.*failed|error:" test-output-${{ matrix.device }}.txt | head -10 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results-${{ matrix.device }}
          path: |
            build/test-results-${{ matrix.device }}.xcresult
            test-output-${{ matrix.device }}.txt
          retention-days: 7
          if-no-files-found: ignore
          compression-level: 6

  test-macos:
    name: Test macOS
    runs-on: macos-14
    timeout-minutes: 20
    needs: [build-macos]
    if: always() && github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: Cache test results
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build
          key: ${{ runner.os }}-test-macos-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-test-macos-
      
      - name: Run macOS unit tests
        id: test
        run: |
          set -o pipefail
          xcodebuild test \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-macOS" \
            -sdk macosx \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -destination 'platform=macOS' \
            -derivedDataPath build \
            -resultBundlePath build/test-results-macos.xcresult \
            -only-testing:DisabilityAdvocacyTests \
            2>&1 | tee test-output-macos.txt || TEST_EXIT_CODE=$?
      
      - name: Parse test results
        if: always()
        run: |
          if [ -f "test-output-macos.txt" ]; then
            echo "## macOS Test Results" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Extract test summary
            if grep -q "Test Suite" test-output-macos.txt; then
              grep -A 5 "Test Suite" test-output-macos.txt | head -20 >> $GITHUB_STEP_SUMMARY || true
            fi
            
            # Extract passed/failed counts
            PASSED=$(grep -oE "[0-9]+ passed" test-output-macos.txt | head -1 || echo "0 passed")
            FAILED=$(grep -oE "[0-9]+ failed" test-output-macos.txt | head -1 || echo "0 failed")
            
            echo "Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-results
          path: |
            build/test-results-macos.xcresult
            test-output-macos.txt
          retention-days: 7
          if-no-files-found: ignore
          compression-level: 6

  # Validation Jobs
  validate-build:
    name: Validate Build
    runs-on: macos-14
    timeout-minutes: 15
    needs: [build-ios, build-macos]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: Run build validation
        run: |
          chmod +x scripts/validate-build.sh || true
          ./scripts/validate-build.sh || echo "âš ï¸ Build validation completed with warnings"
      
      - name: Run platform code validation
        run: |
          chmod +x scripts/validate-platform-code.sh || true
          ./scripts/validate-platform-code.sh || echo "âš ï¸ Platform validation completed with warnings"
      
      - name: Check for common issues
        run: |
          echo "Checking for common build issues..."
          
          # Check for force unwraps
          FORCE_UNWRAPS=$(find . -name "*.swift" -not -path "./build/*" -exec grep -l "!" {} \; | wc -l || echo "0")
          echo "Files with force unwraps: $FORCE_UNWRAPS"
          
          # Check for print statements (should use logger)
          PRINT_STATEMENTS=$(find . -name "*.swift" -not -path "./build/*" -exec grep -c "print(" {} \; | awk '{s+=$1} END {print s}' || echo "0")
          echo "Print statements found: $PRINT_STATEMENTS"
          
          # Check for TODO/FIXME
          TODO_COUNT=$(find . -name "*.swift" -not -path "./build/*" -exec grep -c "TODO\|FIXME" {} \; | awk '{s+=$1} END {print s}' || echo "0")
          echo "TODO/FIXME comments: $TODO_COUNT"
          
          echo "### Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Force unwraps: $FORCE_UNWRAPS files" >> $GITHUB_STEP_SUMMARY
          echo "- Print statements: $PRINT_STATEMENTS" >> $GITHUB_STEP_SUMMARY
          echo "- TODO/FIXME: $TODO_COUNT" >> $GITHUB_STEP_SUMMARY

  # Security Scanning
  security-scan:
    name: Security Scan
    runs-on: macos-14
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential secrets..."
          
          # Check for API keys, tokens, etc.
          SECRET_PATTERNS=("api[_-]?key" "secret" "token" "password" "auth[_-]?token")
          FOUND_SECRETS=0
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            MATCHES=$(grep -r -i "$pattern" --include="*.swift" --include="*.plist" --include="*.json" . 2>/dev/null | grep -v ".git" | grep -v "node_modules" | wc -l || echo "0")
            if [ "$MATCHES" -gt 0 ]; then
              echo "âš ï¸ Found potential secrets matching '$pattern': $MATCHES"
              FOUND_SECRETS=$((FOUND_SECRETS + MATCHES))
            fi
          done
          
          if [ "$FOUND_SECRETS" -gt 0 ]; then
            echo "âš ï¸ Security scan found $FOUND_SECRETS potential issues"
            echo "Please review and ensure no secrets are committed."
          else
            echo "âœ“ No obvious secrets found"
          fi
      
      - name: Check dependencies
        run: |
          echo "Checking for dependency vulnerabilities..."
          echo "Note: For Swift Package Manager, use 'swift package show-dependencies'"
          echo "âœ“ Dependency check complete (manual review recommended)"

  # Build Status Summary
  build-status:
    name: Build Status Summary
    runs-on: ubuntu-latest
    needs: [build-ios, build-macos, test-ios, test-macos, validate-build, security-scan, check-swift-concurrency]
    if: always()
    steps:
      - name: Generate comprehensive status summary
        run: |
          echo "# ðŸš€ Build and Test Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build Status
          echo "## ðŸ“¦ Platform Builds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Configuration | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | Debug | ${{ needs.build-ios.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | Release | ${{ needs.build-ios.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | Debug | ${{ needs.build-macos.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | Release | ${{ needs.build-macos.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test Status
          echo "## ðŸ§ª Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Unit Tests | ${{ needs.test-ios.result == 'success' && 'âœ… Passed' || needs.test-ios.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Unit Tests | ${{ needs.test-macos.result == 'success' && 'âœ… Passed' || needs.test-macos.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Validation Status
          echo "## âœ… Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Swift 6 Concurrency Check | ${{ needs.check-swift-concurrency.result == 'success' && 'âœ… Passed' || needs.check-swift-concurrency.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Validation | ${{ needs.validate-build.result == 'success' && 'âœ… Passed' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.lint.result == 'success' && 'âœ… Passed' || needs.lint.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Metadata
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** ${{ env.CONFIGURATION }}" >> $GITHUB_STEP_SUMMARY
          
          # Overall Status
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-ios.result }}" == "success" ] && [ "${{ needs.build-macos.result }}" == "success" ]; then
            echo "### âœ… Overall Status: **SUCCESS**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Overall Status: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
