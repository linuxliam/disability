name: Code Coverage

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.0'

jobs:
  coverage:
    name: Generate Code Coverage
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: |
          if [ -d "/Applications/Xcode_${XCODE_VERSION}.app" ]; then
            sudo xcode-select -s /Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer
          fi
      
      - name: Find available iOS Simulator
        id: simulator
        run: |
          # Find any available iPhone simulator
          DEVICE_UDID=$(xcrun simctl list devices available | grep -i "iphone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' | head -1)
          
          if [ -z "$DEVICE_UDID" ]; then
            echo "use_generic=true" >> $GITHUB_OUTPUT
          else
            echo "use_generic=false" >> $GITHUB_OUTPUT
            echo "device_udid=$DEVICE_UDID" >> $GITHUB_OUTPUT
            # Boot the simulator
            xcrun simctl boot "$DEVICE_UDID" 2>/dev/null || true
            sleep 5
          fi
      
      - name: Run tests with coverage
        run: |
          if [ "${{ steps.simulator.outputs.use_generic }}" == "true" ]; then
            DESTINATION="generic/platform=iOS Simulator"
          else
            DESTINATION="platform=iOS Simulator,id=${{ steps.simulator.outputs.device_udid }}"
          fi
          
          echo "Using destination: $DESTINATION"
          
          xcodebuild test \
            -project DisabilityAdvocacy.xcodeproj \
            -scheme "DisabilityAdvocacy-iOS" \
            -sdk iphonesimulator \
            -destination "$DESTINATION" \
            -enableCodeCoverage YES \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Generate coverage report
        run: |
          xcrun xccov view --report --only-targets build/Logs/Test/*.xcresult > coverage-report.txt || true
      
      - name: Calculate coverage percentage
        id: coverage
        run: |
          if [ -f "coverage-report.txt" ]; then
            COVERAGE=$(grep -oP '^\d+\.\d+%' coverage-report.txt | head -1 | sed 's/%//' || echo "0")
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "Coverage: ${COVERAGE}%"
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
            echo "Coverage: 0% (report not generated)"
          fi
      
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.coverage.outputs.percentage }}';
            const percentage = parseFloat(coverage) || 0;
            
            const emoji = percentage >= 80 ? '‚úÖ' : percentage >= 60 ? '‚ö†Ô∏è' : '‚ùå';
            const status = percentage >= 80 ? 'excellent' : percentage >= 60 ? 'good' : 'needs improvement';
            
            const body = `## üìä Code Coverage Report
            ${emoji} **Coverage: ${percentage}%** (${status})
            
            ### Coverage Goals
            - üéØ Target: 80%+
            - ‚ö†Ô∏è  Warning: < 60%
            
            ### Next Steps
            ${percentage < 80 ? '- Consider adding more tests to improve coverage' : '- Great job! Coverage is above target'}
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Code Coverage Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report.txt
          retention-days: 30
